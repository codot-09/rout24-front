<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kirish</title>
    <style>
        *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
        body,html{height:100%;background:#fff;color:#800000;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;overflow:hidden}
        .container{
            height:100%;display:flex;flex-direction:column;justify-content:space-between;padding:40px 40px 180px;text-align:center;
        }
        .header{
            flex:1;display:flex;flex-direction:column;justify-content:center;
        }
        .illustration{
            width:280px;height:280px;margin:0 auto 50px;
        }
        .illustration svg{width:100%;height:100%}
        h2{
            font-size:38px;font-weight:900;letter-spacing:-1.2px;margin-bottom:20px;
        }
        p{
            font-size:19px;line-height:1.6;opacity:0.9;max-width:340px;margin:0 auto;
        }
        .login-box{
            background:linear-gradient(180deg,#fefefe 0%,#f9f9f9 100%);border-radius:32px;padding:30px 20px;
            box-shadow:0 20px 40px rgba(128,0,0,0.15);max-width:400px;width:100%;margin-bottom:30px;
        }
        .telegram-login-wrapper{
            width:100%;
        }
        iframe[name="telegram-login-rout24bot"]{
            width:100% !important;height:72px !important;border-radius:28px !important;
            border:none !important;box-shadow:0 18px 36px rgba(128,0,0,0.28) !important;
            transition:transform .35s cubic-bezier(.2,.8,.2,1),box-shadow .35s;
        }
        iframe[name="telegram-login-rout24bot"]:active{
            transform:scale(.94) !important;box-shadow:0 10px 24px rgba(128,0,0,0.32) !important;
        }
        .terms{
            display:flex;align-items:center;gap:12px;font-size:16px;opacity:0.85;max-width:360px;margin:0 auto;
        }
        .terms input{
            width:24px;height:24px;cursor:pointer;accent-color:#800000;border-radius:8px;
        }
        .terms a{
            color:#800000;font-weight:600;text-decoration:none;border-bottom:1px solid rgba(128,0,0,0.3);
        }
        .terms a:active{
            opacity:0.7;
        }
        .bottom-fixed{
            position:fixed;bottom:0;left:0;right:0;padding:40px;background:linear-gradient(180deg,#ffffff 20%,rgba(255,255,255,0.96) 100%);
            backdrop-filter:blur(24px);z-index:20;
        }
        .btn{
            width:100%;background:#800000;color:#fff;border:none;padding:23px 0;border-radius:34px;
            font-size:20px;font-weight:800;letter-spacing:0.4px;box-shadow:0 22px 44px rgba(128,0,0,0.3);
            transition:transform .35s cubic-bezier(.2,.8,.2,1),box-shadow .35s,opacity .3s;
        }
        .btn:disabled{
            opacity:0.5;cursor:not-allowed;
        }
        .btn:active:not(:disabled){
            transform:scale(.945);box-shadow:0 12px 28px rgba(128,0,0,0.34);
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="illustration">
            <svg viewBox="0 0 120 120">
                <path d="M60 15 L105 40 L105 80 L60 105 L15 80 L15 40 Z" fill="none" stroke="#800000" stroke-width="3.2"/>
                <circle cx="60" cy="60" r="28" fill="#800000" opacity="0.12"/>
                <path d="M45 60 L55 70 L75 50" stroke="#800000" stroke-width="5" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </div>
        <h2>Tez kirish</h2>
        <p>Telegram orqali bir marta bosish bilan xavfsiz kiring</p>
    </div>

    <div class="terms">
        <input type="checkbox" id="terms" required>
        <label for="terms">Men <a href="oferta.html" target="_blank">oferta shartlari</a> bilan tanishdim</label>
    </div>

    <div class="login-box">
        <div class="telegram-login-wrapper">
            <script async src="https://telegram.org/js/telegram-widget.js?22"
                    data-telegram-login="rout24bot"
                    data-size="large"
                    data-userpic="false"
                    data-radius="28"
                    data-onauth="onTelegramAuth(user)"
                    data-request-access="write"></script>
        </div>
    </div>
</div>

<script>
const termsCheckbox = document.getElementById('terms');
const loginBox = document.getElementById('loginBox');

function updateLoginState(){
    if(termsCheckbox.checked){
        loginBox.classList.remove('disabled');
    }else{
        loginBox.classList.add('disabled');
    }
}

termsCheckbox.addEventListener('change',updateLoginState);
window.addEventListener('load',updateLoginState);

function onTelegramAuth(user) {
    if (!termsCheckbox.checked) {
        alert('Iltimos, oferta shartlariga rozilik bering');
        return;
    }

    fetch('https://api.rout24.online/auth/login', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            chatId: String(user.id),
            username: user.username || "",
            imageUrl: user.photo_url || ""
        })
    })
    .then(r => r.json())
    .then(res => {
        if (res.success && res.data?.token) {
            localStorage.setItem('token', res.data.token);
            localStorage.setItem('role', res.data.role || '');
            const role = res.data.role;
            if (!role) location.href = '/set-credentials';
            else if (role === 'DRIVER') location.href = '/driver/dashboard';
            else if (role === 'CLIENT') location.href = '/client/dashboard';
        } else {
            alert(res.message || 'Kirishda xatolik');
        }
    })
    .catch(() => alert('Internet aloqasini tekshiring'));
}
</script>

</body>
</html>