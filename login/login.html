<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kirish | Rout24</title>
    <style>
        :root {
            --brand: #800000;
            --brand-dark: #4a0000;
            --brand-soft: #fff5f5;
            --glass: rgba(255, 255, 255, 0.95);
            --text-main: #2d3436;
            --text-muted: #636e72;
        }

        * { margin: 0; padding: 0; box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
    outline: none; }

        body {
            background-color: #f0f2f5;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            color: var(--text-main);
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .auth-card {
            background: white;
            width: 100%;
            max-width: 420px;
            margin: 20px;
            padding: 40px 32px;
            border-radius: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            text-align: center;
        }

        .illustration-box {
            width: 120px;
            height: 120px;
            background: var(--brand-soft);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 32px;
            color: var(--brand);
        }

        .illustration-box svg {
            width: 64px;
            height: 64px;
        }

        h2 {
            font-size: 28px;
            font-weight: 800;
            color: var(--brand-dark);
            margin-bottom: 12px;
            letter-spacing: -0.5px;
        }

        p {
            font-size: 16px;
            line-height: 1.5;
            color: var(--text-muted);
            margin-bottom: 40px;
        }

        .login-section {
            background: #fafafa;
            border: 1px solid #eee;
            border-radius: 20px;
            padding: 24px;
            transition: 0.3s ease;
        }

        .tg-wrapper {
            opacity: 0.4;
            pointer-events: none;
            transition: all 0.4s ease;
            transform: translateY(5px);
            display: flex;
            justify-content: center;
        }

        .tg-wrapper.active {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }

        .terms-container {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            text-align: left;
            margin-bottom: 24px;
            padding: 0 4px;
        }

        .terms-container input {
            width: 20px;
            height: 20px;
            margin-top: 2px;
            accent-color: var(--brand);
            cursor: pointer;
        }

        .terms-container label {
            font-size: 14px;
            color: var(--text-muted);
            line-height: 1.4;
        }

        .terms-container a {
            color: var(--brand);
            text-decoration: none;
            font-weight: 600;
        }

        .terms-container a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>

<div class="auth-card">
    <div class="illustration-box">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
            <path d="M9 12l2 2 4-4"></path>
        </svg>
    </div>

    <h2>Tez kirish</h2>
    <p>Tizimga kirish uchun oferta shartlarini qabul qiling va Telegram orqali tasdiqlang.</p>

    <div class="terms-container">
        <input type="checkbox" id="terms">
        <label for="terms">
            Men <a href="/terms" target="_blank">oferta shartlari</a> va maxfiylik siyosati bilan tanishdim hamda ularga roziman.
        </label>
    </div>

    <div class="login-section">
        <div class="tg-wrapper" id="tgLogin">
            <script async src="https://telegram.org/js/telegram-widget.js?22"
                    data-telegram-login="rout24bot"
                    data-size="large"
                    data-userpic="false"
                    data-radius="15"
                    data-onauth="onTelegramAuth(user)"
                    data-request-access="write"></script>
        </div>
    </div>
</div>

<script>
const termsCheckbox = document.getElementById('terms');
const tgLogin = document.getElementById('tgLogin');

function updateLoginState() {
    if (termsCheckbox.checked) {
        tgLogin.classList.add('active');
    } else {
        tgLogin.classList.remove('active');
    }
}

termsCheckbox.addEventListener('change', updateLoginState);

function onTelegramAuth(user) {
    if (!termsCheckbox.checked) return;

    fetch('https://api.rout24.online/auth/login', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            chatId: String(user.id),
            username: user.username || "",
            imageUrl: user.photo_url || ""
        })
    })
    .then(r => r.json())
    .then(res => {
        if (res.success && res.data?.token) {
            localStorage.setItem('token', res.data.token);
            localStorage.setItem('role', res.data.role || '');
            const role = res.data.role;
            
            if (!role) {
                location.href = '/set-credentials';
            } else if (role === 'DRIVER') {
                location.href = '/driver/dashboard';
            } else if (role === 'CLIENT') {
                location.href = '/client/dashboard';
            } else if (role === 'ADMIN') {
                window.location.href = 'https://rout-admin.netlify.app';
            }
        } else {
            alert(res.message || 'Kirishda xatolik yuz berdi');
        }
    })
    .catch(() => alert('Tarmoq ulanishini tekshiring'));
}
</script>

</body>
</html>