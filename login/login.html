<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kirish</title>
    <meta name="description" content="Tez va xavfsiz Telegram orqali kirish">

    <style>
        :root {
            --primary: #800000;
            --primary-light: #a00000;
            --primary-shadow: rgba(128, 0, 0, 0.25);
            --bg-gradient: linear-gradient(180deg, #ffffff 20%, rgba(255, 255, 255, 0.96) 100%);
            --text-primary: #800000;
            --text-secondary: rgba(0, 0, 0, 0.85);
            --radius-lg: 32px;
            --radius-md: 28px;
            --radius-sm: 8px;
            --transition: all 0.35s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body, html {
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', sans-serif;
            background: #fff;
            color: var(--text-primary);
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 40px 24px 180px;
            text-align: center;
        }

        .header {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 32px;
        }

        .illustration {
            width: 180px; /* Rasmni kichikroq qildim */
            height: 180px;
            margin: 0 auto;
        }

        .illustration img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            /* SVG o'rniga PNG ishlatilmoqda, zarur bo'lsa filter qo'shish mumkin */
            filter: drop-shadow(0 4px 12px rgba(128, 0, 0, 0.15));
        }

        h2 {
            font-size: 38px;
            font-weight: 900;
            letter-spacing: -1.2px;
            line-height: 1.2;
        }

        p {
            font-size: 19px;
            line-height: 1.6;
            opacity: 0.9;
            max-width: 340px;
            margin: 0 auto;
            color: var(--text-secondary); /* Matnni o'qilishi uchun kulrangroq qildim */
        }

        .terms {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-size: 16px;
            color: var(--text-secondary);
            opacity: 0.85;
            max-width: 360px;
            margin: 0 auto 24px;
        }

        .terms input[type="checkbox"] {
            width: 24px;
            height: 24px;
            accent-color: var(--primary);
            border-radius: var(--radius-sm);
            cursor: pointer;
        }

        .terms label {
            cursor: pointer;
        }

        .terms a {
            color: var(--primary);
            font-weight: 600;
            text-decoration: none;
            border-bottom: 1px solid rgba(128, 0, 0, 0.3);
            transition: opacity 0.2s;
        }

        .terms a:active {
            opacity: 0.7;
        }

        .login-box {
            background: linear-gradient(180deg, #fefefe 0%, #f9f9f9 100%);
            border-radius: var(--radius-lg);
            padding: 30px 20px;
            box-shadow: 0 20px 40px var(--primary-shadow);
            max-width: 400px;
            width: 100%;
            margin: 0 auto;
        }

        .telegram-login-wrapper {
            width: 100%;
            /* Boshida yashirish */
            opacity: 0; 
            pointer-events: none;
            transition: var(--transition);
        }
        
        .telegram-login-wrapper.active {
            /* Faol holatda ko'rsatish */
            opacity: 1;
            pointer-events: auto;
        }

        /* Telegram iframe'ini stilizatsiya qilish */
        .telegram-login-wrapper iframe {
            width: 100% !important;
            height: 72px !important;
            border-radius: var(--radius-md) !important;
            border: none !important;
            box-shadow: 0 18px 36px rgba(128, 0, 0, 0.28) !important;
            transition: var(--transition);
        }

        .telegram-login-wrapper.active iframe:active {
            transform: scale(0.94) !important;
            box-shadow: 0 10px 24px rgba(128, 0, 0, 0.32) !important;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="illustration" aria-hidden="true">
            <img src="/assets/icon.png" alt="Ilova logotipi va xavfsiz kirish belgisi">
        </div>
        <h2>Xush kelibsiz!</h2>
        <p>Telegram orqali bir marta bosish bilan tez va xavfsiz kiring</p>
    </div>

    <div class="bottom-fixed">
        <div class="terms">
            <input type="checkbox" id="terms" required aria-required="true">
            <label for="terms">
                Men <a href="oferta.html" target="_blank" rel="noopener">oferta shartlari</a> bilan tanishdim va roziman
            </label>
        </div>

        <div class="login-box">
            <div class="telegram-login-wrapper" id="telegram-wrapper">
                <script async src="https://telegram.org/js/telegram-widget.js?22"
                        data-telegram-login="rout24bot"
                        data-size="large"
                        data-userpic="false"
                        data-radius="28"
                        data-onauth="onTelegramAuth(user)"
                        data-request-access="write"></script>
            </div>
            
            <button class="btn" id="login-button-placeholder" disabled>
                Oferta shartlarini tasdiqlang
            </button>
        </div>
    </div>
</div>

<script>
    const termsCheckbox = document.getElementById('terms');
    const telegramWrapper = document.getElementById('telegram-wrapper');
    const placeholderButton = document.getElementById('login-button-placeholder');

    /**
     * Oferta shartlari holatiga qarab kirish usulini boshqaradi.
     */
    function toggleLoginMethod() {
        const isChecked = termsCheckbox.checked;

        if (isChecked) {
            // Agar tasdiqlangan bo'lsa: Telegram widget'ni ko'rsat, joy saqlovchi tugmani yashir.
            telegramWrapper.classList.add('active');
            placeholderButton.style.display = 'none';
        } else {
            // Agar tasdiqlanmagan bo'lsa: Telegram widget'ni yashir, joy saqlovchi tugmani ko'rsat.
            telegramWrapper.classList.remove('active');
            placeholderButton.style.display = 'block';
            placeholderButton.textContent = 'Oferta shartlarini tasdiqlang';
        }
    }

    // Holat o'zgarganda funksiyani chaqirish
    termsCheckbox.addEventListener('change', toggleLoginMethod);

    // Sahifa yuklanganda boshlang'ich holatni o'rnatish
    window.addEventListener('load', toggleLoginMethod);
    // Yuklanish jarayoni Telegram widget'iga bog'liq bo'lishi mumkin
    // Shuning uchun uni tezroq chaqiramiz
    if (document.readyState === 'complete') {
        toggleLoginMethod();
    }


    // Telegram auth callback
    function onTelegramAuth(user) {
        if (!termsCheckbox.checked) {
            // Agar foydalanuvchi qandaydir yo'l bilan shartlarni tasdiqlamay turib
            // Telegram tugmasini bosa, uni qayta ogohlantirish
            alert('Iltimos, avval oferta shartlariga rozilik bering');
            toggleLoginMethod(); // Holatni yangilash
            return;
        }

        // Yuklashni ko'rsatish
        if (placeholderButton.style.display !== 'block') {
            placeholderButton.style.display = 'block';
            telegramWrapper.style.display = 'none';
        }
        placeholderButton.disabled = true;
        placeholderButton.textContent = 'Kirish jarayoni...';

        const payload = {
            chatId: String(user.id),
            username: user.username ?? '',
            imageUrl: user.photo_url ?? ''
        };

        fetch('https://api.rout24.online/auth/login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        })
        .then(response => {
            if (!response.ok) throw new Error('Server responded with error');
            return response.json();
        })
        .then(data => {
            if (data.success && data.data?.token) {
                localStorage.setItem('token', data.data.token);
                localStorage.setItem('role', data.data.role || '');

                const role = data.data.role;

                if (!role) {
                    window.location.href = '/set-credentials';
                } else if (role === 'DRIVER') {
                    window.location.href = '/driver/dashboard';
                } else if (role === 'CLIENT') {
                    window.location.href = '/client/dashboard';
                } else {
                    window.location.href = '/'; // fallback
                }
            } else {
                alert(data.message || 'Kirishda xatolik yuz berdi');
                placeholderButton.textContent = 'Xatolik. Qayta urinish';
                placeholderButton.disabled = false;
            }
        })
        .catch(error => {
            console.error('Login error:', error);
            alert('Internet aloqasini tekshiring yoki keyinroq urinib koâ€˜ring');
            placeholderButton.textContent = 'Aloqa xatosi. Qayta urinish';
            placeholderButton.disabled = false;
        });
    }

    // Optional: expose to global scope if Telegram widget requires it
    window.onTelegramAuth = onTelegramAuth;
</script>

</body>
</html>