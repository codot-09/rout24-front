<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QR Skaner</title>
    <link rel="stylesheet" href="/dashboard/driver/driver-dashboard.css">
    <script src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"></script>
    <style>
        .scanner-wrapper{padding:20px 20px 120px}
        .title{text-align:center;font-size:24px;font-weight:900;margin-bottom:30px}
        .scanner-box{position:relative;max-width:420px;margin:0 auto;border-radius:24px;overflow:hidden;box-shadow:0 12px 40px rgba(128,0,0,.18)}
        #video{width:100%;display:block}
        .scan-frame{position:absolute;inset:20%;border:3px solid #800000;border-radius:16px;box-sizing:border-box;pointer-events:none;animation:pulse 2s infinite}
        @keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(128,0,0,.4)}50%{box-shadow:0 0 0 14px rgba(128,0,0,0)}}
        .detected{position:absolute;bottom:16px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.75);color:#fff;padding:10px 20px;border-radius:12px;font-size:15px;font-weight:700;opacity:0;transition:opacity .4s}
        .detected.show{opacity:1}
        .manual{margin-top:32px;text-align:center}
        .manual input{width:100%;max-width:320px;padding:14px 18px;border:2px solid #800000;border-radius:16px;font-size:17px;background:#fff;color:#800000}
        .manual button{margin-top:12px;background:#800000;color:#fff;border:none;padding:14px 32px;border-radius:16px;font-size:17px;font-weight:600;cursor:pointer}
        .msg{margin-top:20px;font-size:16px;text-align:center;min-height:24px}
        .error{color:#c62828}
        .success{color:#43a047}
        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:1000}
        .modal{background:#fff;border-radius:24px;padding:32px 24px;width:90%;max-width:380px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.3);animation:a .4s}
        .modal-icon{width:80px;height:80px;background:#43a047;border-radius:50%;margin:0 auto 20px;display:flex;align-items:center;justify-content:center}
        .modal-icon svg{width:48px;height:48px;fill:#fff}
        .modal h3{font-size:22px;font-weight:900;margin:0 0 12px}
        .modal p{font-size:15px;color:#555;margin-bottom:24px}
        .modal button{background:#800000;color:#fff;border:none;padding:14px 40px;border-radius:16px;font-size:17px;font-weight:600;cursor:pointer}
        @keyframes a{from{opacity:0;transform:scale(.8)}to{opacity:1;transform:scale(1)}}
    </style>
</head>
<body>

<header class="header">
    <div class="logo"><img src="/assets/icon.png" alt="Rout24"><span>Rout24</span></div>
    <button onclick="history.back()" style="background:none;border:none">
        <svg width="28" height="28" fill="#800000" viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg>
    </button>
</header>

<main class="main scanner-wrapper">
    <h2 class="title">QR kodni skanerlang</h2>
    <div class="scanner-box">
        <video id="video" autoplay playsinline muted></video>
        <div class="scan-frame"></div>
        <div class="detected" id="detected">100001</div>
        <canvas id="canvas" style="display:none"></canvas>
    </div>

    <div class="manual">
        <input type="text" id="billing" placeholder="Yoki billing raqamini kiriting">
        <button id="sendBtn">Tasdiqlash</button>
    </div>
    <div id="msg" class="msg"></div>
</main>

<div class="modal-overlay" id="modal">
    <div class="modal">
        <div class="modal-icon">
            <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
        </div>
        <h3>Buyurtma tasdiqlandi!</h3>
        <p id="modalText">Muvaffaqiyatli amalga oshirildi</p>
        <button onclick="location.href='/dashboard/driver'">Asosiy sahifaga</button>
    </div>
</div>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const detectedEl = document.getElementById('detected');
const msg = document.getElementById('msg');
const billingInput = document.getElementById('billing');
const sendBtn = document.getElementById('sendBtn');
const modal = document.getElementById('modal');
const modalText = document.getElementById('modalText');

const TOKEN = localStorage.getItem('token');

let stream = null;
let lastCode = '';
let holdTimer = null;

async function start() {
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
    video.srcObject = stream;
    await video.play();
    requestAnimationFrame(scan);
}

function scan() {
    if (video.readyState !== video.HAVE_ENOUGH_DATA) {
        requestAnimationFrame(scan);
        return;
    }

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0);

    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const code = jsQR(imageData.data, imageData.width, imageData.height);

    if (code) {
        const text = code.data.trim();
        const billingNumber = text.match(/^\d+$/) ? text : null;

        if (billingNumber && billingNumber !== lastCode) {
            lastCode = billingNumber;
            detectedEl.textContent = billingNumber;
            detectedEl.classList.add('show');
            clearTimeout(holdTimer);
            holdTimer = setTimeout(() => verify(billingNumber), 1000);
        }
    } else {
        if (lastCode) {
            lastCode = '';
            detectedEl.classList.remove('show');
            clearTimeout(holdTimer);
        }
    }

    requestAnimationFrame(scan);
}

async function verify(billingNumber) {
    msg.textContent = 'Tasdiqlanmoqdaâ€¦';
    try {
        const res = await fetch(`https://api.rout24.online/orders/verify/billing/${billingNumber}`, {
            method: 'PATCH',
            headers: {
                'Accept': 'application/json',
                'Authorization': `Bearer ${TOKEN}`
            }
        });

        const data = await res.json();

        if (data.success) {
            modalText.textContent = data.message || 'Buyurtma tasdiqlandi';
            modal.style.display = 'flex';
            stop();
        } else {
            msg.textContent = data.message || 'Xato';
            msg.className = 'msg error';
            reset();
        }
    } catch (e) {
        msg.textContent = 'Ulanish xatosi';
        msg.className = 'msg error';
        reset();
    }
}

sendBtn.onclick = () => {
    const val = billingInput.value.trim();
    if (/^\d+$/.test(val)) verify(val);
    else msg.textContent = 'Faqat raqam', msg.className = 'msg error';
};

function reset() {
    lastCode = '';
    detectedEl.classList.remove('show');
    setTimeout(() => {
        msg.textContent = '';
        msg.className = 'msg';
    }, 2000);
}

function stop() {
    if (stream) stream.getTracks().forEach(t => t.stop());
}

window.onload = start;
window.onbeforeunload = stop;
</script>
</body>
</html>