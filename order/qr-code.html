<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QR Skaner</title>
    <link rel="stylesheet" href="/dashboard/driver/driver-dashboard.css">
    <script src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"></script>
    <style>
        .scanner-wrapper {padding: 20px 20px 100px}
        .title {text-align:center; font-size:24px; font-weight:900; margin-bottom:30px}
        .scanner-box {position:relative; max-width:420px; margin:0 auto; border-radius:24px; overflow:hidden; box-shadow:0 12px 40px rgba(128,0,0,.18)}
        #video {width:100%; display:block}
        .scan-frame {position:absolute; inset:0; border:3px solid #800000; box-sizing:border-box; pointer-events:none}
        .manual {margin-top:32px; text-align:center}
        .manual input {width:100%; max-width:320px; padding:14px 18px; border:2px solid #800000; border-radius:16px; font-size:17px; background:#fff; color:#800000}
        .manual button {margin-top:12px; background:#800000; color:#fff; border:none; padding:14px 32px; border-radius:16px; font-size:17px; font-weight:600; cursor:pointer}
        .msg {margin-top:20px; font-size:16px; text-align:center; min-height:24px}
        .error {color:#c62828}
        .success {color:#43a047}
    </style>
</head>
<body>

<header class="header">
    <div class="logo">
        <img src="/assets/icon.png" alt="Rout24">
        <span>Rout24</span>
    </div>
    <button onclick="history.back()" style="background:none;border:none">
        <svg width="28" height="28" fill="#800000" viewBox="0 0 24 24">
            <path d="M15 18l-6-6 6-6"/>
        </svg>
    </button>
</header>

<main class="main scanner-wrapper">
    <h2 class="title">QR kodni skanerlang</h2>

    <div class="scanner-box">
        <video id="video" autoplay playsinline muted></video>
        <div class="scan-frame"></div>
        <canvas id="canvas" style="display:none"></canvas>
    </div>

    <div class="manual">
        <input type="text" id="billing" placeholder="Yoki billing raqamini kiriting">
        <button id="sendBtn">Tasdiqlash</button>
    </div>

    <div id="msg" class="msg"></div>
</main>

<script>
    const API_URL = 'https://api.rout24.online/orders/verify/';
    const TOKEN = localStorage.getItem('token')

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const msgEl = document.getElementById('msg');
    const billingInput = document.getElementById('billing');
    const sendBtn = document.getElementById('sendBtn');

    let scanning = false;
    let stream = null;

    async function initScanner() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            video.srcObject = stream;
            await video.play();
            scanning = true;
            requestAnimationFrame(scanFrame);
        } catch (err) {
            showMessage('Kamera ochishda xato: ' + err.message, 'error');
        }
    }

    function scanFrame() {
        if (!scanning || video.readyState !== video.HAVE_ENOUGH_DATA) {
            requestAnimationFrame(scanFrame);
            return;
        }

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height);

        if (code) {
            const value = code.data.trim();
            if (value.startsWith('https://i.ibb.co')) {
                scanning = false;
                verifyOrder(value);
            }
        }

        requestAnimationFrame(scanFrame);
    }

    async function verifyOrder(value) {
        showMessage('Tasdiqlanmoqda...');
        try {
            const response = await fetch(API_URL + encodeURIComponent(value), {
                method: 'PATCH',
                headers: {
                    'Accept': '*/*',
                    'Authorization': `Bearer ${TOKEN}`,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }

            const data = await response.json();
            if (data.success) {
                showMessage(data.message || 'Muvaffaqiyatli tasdiqlandi!', 'success');
            } else {
                showMessage(data.message || (data.errors ? data.errors.join(', ') : 'NomaÊ¼lum xato'), 'error');
                setTimeout(() => { scanning = true; }, 2000);
            }
        } catch (err) {
            showMessage('Ulanish xatosi: ' + err.message, 'error');
            setTimeout(() => { scanning = true; }, 2000);
        }
    }

    sendBtn.addEventListener('click', () => {
        const value = billingInput.value.trim();
        if (value) {
            verifyOrder(value);
        } else {
            showMessage('Billing raqamini kiriting!', 'error');
        }
    });

    function showMessage(text, type = '') {
        msgEl.textContent = text;
        msgEl.className = `msg ${type}`;
    }

    window.addEventListener('load', initScanner);

    window.addEventListener('beforeunload', () => {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }
    });
</script>

</body>
</html>