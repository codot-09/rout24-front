<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Reys Tafsilotlari</title>
<style>
  :root {
    --main: #800000;
    --main-dark: #660000;
    --main-light: #a00000;
    --white: #ffffff;
    --gray-100: #f8f9fa;
    --gray-300: #dee2e6;
    --gray-600: #6c757d;
    --gray-800: #343a40;
    --radius: 20px;
    --radius-sm: 16px;
    --shadow: 0 10px 30px rgba(128, 0, 0, 0.12);
    --transition: all 0.3s ease;
  }

  * { margin:0; padding:0; box-sizing:border-box;
    -webkit-tap-highlight-color: transparent;
    outline: none; }
  body, html {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: #f5f5f5;
    color: var(--gray-800);
    min-height: 100vh;
  }

  .header {
    position: sticky;
    top: 0;
    height: 64px;
    background: var(--main);
    color: white;
    display: flex;
    align-items: center;
    padding: 0 16px;
    z-index: 100;
    box-shadow: 0 4px 15px rgba(128,0,0,0.2);
  }

  .back-btn {
    width: 46px;
    height: 46px;
    border-radius: 50%;
    background: rgba(255,255,255,0.18);
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: var(--transition);
  }
  .back-btn:active { background: rgba(255,255,255,0.3); transform: scale(0.92); }

  .header h1 { font-size: 19px; font-weight: 700; margin-left: 14px; }

  .main { padding: 16px; padding-bottom: 100px; max-width: 600px; margin: 0 auto; }

  .location-card {
    background: white;
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 14px;
    box-shadow: var(--shadow);
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .location-icon {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: var(--main);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }
  .location-icon.from { background: var(--main); }
  .location-icon.to { background: #006400; }

  .location-text h3 { font-size: 22px; font-weight: 800; color: var(--gray-800); }
  .location-text p { font-size: 14px; color: var(--gray-600); margin-top: 4px; font-weight: 600; }

  .status-badge {
    display: inline-block;
    padding: 7px 18px;
    border-radius: 30px;
    font-size: 13px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    margin: 10px auto 0;
    background: #e6f4ea;
    color: #065f46;
  }
  .status-badge.finished { background: var(--gray-300); color: var(--gray-700); }

  .info-card {
    background: white;
    border-radius: var(--radius-sm);
    padding: 18px;
    margin-bottom: 14px;
    box-shadow: var(--shadow);
  }

  .info-card h3 {
    font-size: 17px;
    font-weight: 700;
    color: var(--main);
    margin-bottom: 16px;
    padding-bottom: 8px;
    border-bottom: 2px solid var(--main);
  }

  .row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid var(--gray-300);
  }
  .row:last-child { border-bottom: none; }

  .row-label {
    font-size: 15px;
    color: var(--gray-600);
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .row-value {
    font-size: 16px;
    font-weight: 700;
    color: var(--gray-800);
    text-align: right;
    max-width: 60%;
  }

  .gallery {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
    gap: 12px;
    margin-top: 10px;
  }
  .gallery img {
    width: 100%;
    height: 100px;
    object-fit: cover;
    border-radius: 14px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.12);
  }

  .telegram-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    background: #0088cc;
    color: white;
    padding: 14px 20px;
    border-radius: 30px;
    font-weight: 700;
    font-size: 15px;
    text-decoration: none;
    margin-top: 16px;
    transition: var(--transition);
  }
  .telegram-btn:active { transform: scale(0.96); }

  .action-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    padding: 16px;
    padding-bottom: max(20px, env(safe-area-inset-bottom));
    box-shadow: 0 -6px 20px rgba(128,0,0,0.15);
    z-index: 99;
  }

  .book-btn {
    width: 100%;
    padding: 18px;
    background: linear-gradient(90deg, var(--main), var(--main-dark));
    color: white;
    border: none;
    border-radius: var(--radius);
    font-size: 18px;
    font-weight: 800;
    letter-spacing: 0.8px;
    cursor: pointer;
    box-shadow: 0 8px 20px rgba(128,0,0,0.3);
    transition: var(--transition);
  }
  .book-btn:active { transform: translateY(3px); box-shadow: 0 4px 10px rgba(128,0,0,0.3); }
  .book-btn:disabled { background: #999; box-shadow: none; cursor: not-allowed; }

  .loader {
    text-align: center;
    padding: 100px 20px;
    font-size: 18px;
    color: var(--gray-600);
  }

  /* Buyurtmalar bo'limi */
  .orders-section {
    background: white;
    border-radius: var(--radius-sm);
    padding: 18px;
    margin-bottom: 14px;
    box-shadow: var(--shadow);
  }

  .orders-section h3 {
    font-size: 17px;
    font-weight: 700;
    color: var(--main);
    margin-bottom: 16px;
    padding-bottom: 8px;
    border-bottom: 2px solid var(--main);
  }

  .order-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid var(--gray-300);
  }
  .order-item:last-child { border-bottom: none; }

  .order-info {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .order-info .client {
    font-size: 16px;
    font-weight: 700;
    color: var(--gray-800);
  }

  .order-info .details {
    font-size: 14px;
    color: var(--gray-600);
  }

  .order-status {
    font-size: 14px;
    font-weight: 700;
    padding: 6px 12px;
    border-radius: 20px;
    text-transform: uppercase;
  }

  .order-status.PAID { background: #e6f4ea; color: #065f46; }
  .order-status.PENDING { background: #fff3cd; color: #856404; }
  .order-status.WAITING { background: #d1ecf1; color: #0c5460; }
  .order-status.CANCELLED { background: #f8d7da; color: #721c24; }

  .no-orders {
    text-align: center;
    color: var(--gray-600);
    padding: 20px 0;
    font-size: 15px;
    font-weight: 500;
  }
</style>
</head>
<body>

<header class="header">
  <button class="back-btn" onclick="history.back()">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
      <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
    </svg>
  </button>
  <h1>Reys Tafsilotlari</h1>
</header>

<main class="main" id="main">
  <div class="loader">Yuklanmoqda...</div>
</main>

<div class="action-bar" id="action-bar" style="display:none"></div>

<script>
(async () => {
  const token = localStorage.getItem('token');
  const role = localStorage.getItem('role') || 'CLIENT';
  const routeId = new URLSearchParams(location.search).get('id');
  const main = document.getElementById('main');
  const actionBar = document.getElementById('action-bar');

  if (!routeId) {
    main.innerHTML = '<div class="loader" style="color:#800000">Reys ID topilmadi</div>';
    return;
  }

  const err = (msg) => main.innerHTML = `<div class="loader" style="color:#800000">${msg}</div>`;

  try {
    const [routeRes, ordersRes] = await Promise.all([
      fetch(`https://api.rout24.online/routes/${routeId}`, {
        headers: { Authorization: `Bearer ${token}` }
      }),
      fetch(`https://api.rout24.online/orders/route/${routeId}`, {
        headers: { Authorization: `Bearer ${token}` }
      })
    ]);

    if (!routeRes.ok || !ordersRes.ok) throw 0;

    const routeData = await routeRes.json();
    const ordersData = await ordersRes.json();

    if (!routeData.success || !routeData.data) throw 0;

    const d = new Date(routeData.data.departureDate);
    const dateStr = d.toLocaleDateString('uz-UZ', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    const timeStr = d.toLocaleTimeString('uz-UZ', { hour: '2-digit', minute: '2-digit' });
    const priceStr = routeData.data.price ? routeData.data.price.toLocaleString('uz-UZ') + " so‘m" : "Kelishilmagan";

    let ordersHTML = '';
    if (ordersData.success && ordersData.data?.length > 0) {
      ordersHTML = `
        <div class="orders-section">
          <h3>Buyurtmalar (${ordersData.data.length} ta)</h3>
          ${ordersData.data.map(order => `
            <div class="order-item">
              <div class="order-info">
                <div class="client">${order.clientName || 'Noma\'lum mijoz'}</div>
                <div class="details">
                  ${order.seatsCount} ta joy • 
                  ${order.paymentType === 'CARD' ? 'Karta' : 'Naqd'} • 
                  ${order.paymentStatus === 'PAID' ? 'To‘langan' : 'To‘lanmagan'}
                </div>
              </div>
              <span class="order-status ${order.paymentStatus}">
                ${order.paymentStatus === 'PAID' ? 'To‘langan' : order.paymentStatus === 'PENDING' ? 'Kutilmoqda' : 'Kutilmoqda'}
              </span>
            </div>
          `).join('')}
        </div>`;
    } else {
      ordersHTML = `
        <div class="orders-section">
          <h3>Buyurtmalar</h3>
          <div class="no-orders">Hozircha buyurtma yo‘q</div>
        </div>`;
    }

    main.innerHTML = `
      <!-- FROM -->
      <div class="location-card">
        <div class="location-icon from">
          <svg width="28" height="28" fill="white" viewBox="0 0 24 24">
            <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/>
          </svg>
        </div>
        <div class="location-text">
          <h3>${routeData.data.from}</h3>
          <p>Ketish shahri</p>
        </div>
      </div>

      <!-- TO -->
      <div class="location-card">
        <div class="location-icon to">
          <svg width="28" height="28" fill="white" viewBox="0 0 24 24">
            <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/>
          </svg>
        </div>
        <div class="location-text">
          <h3>${routeData.data.to}</h3>
          <p>Yetib borish shahri</p>
        </div>
      </div>

      <div class="status-badge ${routeData.data.finished ? 'finished' : ''}">
        ${routeData.data.finished ? 'Yakunlangan' : 'Faol reys'}
      </div>

      <!-- REYS MA'LUMOTLARI -->
      <div class="info-card">
        <h3>Reys haqida</h3>
        <div class="row"><div class="row-label">Sana</div><div class="row-value">${dateStr}</div></div>
        <div class="row"><div class="row-label">Vaqt</div><div class="row-value">${timeStr}</div></div>
        <div class="row"><div class="row-label">Narx</div><div class="row-value">${priceStr}</div></div>
        <div class="row"><div class="row-label">Bo'sh joy</div><div class="row-value">${routeData.data.seatsCount} ta</div></div>
      </div>

      <!-- MANZILLAR -->
      <div class="info-card">
        <h3>Manzillar</h3>
        <div class="row"><div class="row-label">Ketish</div><div class="row-value">${routeData.data.fromAddress}</div></div>
        <div class="row"><div class="row-label">Borish</div><div class="row-value">${routeData.data.toAddress}</div></div>
      </div>

      <!-- HAYDOVCHI -->
      <div class="info-card">
        <h3>Haydovchi va avtomobil</h3>
        <div class="row"><div class="row-label">F.I.Sh.</div><div class="row-value">${routeData.data.driverFullName || '–'}</div></div>
        <div class="row"><div class="row-label">Transport</div><div class="row-value">${routeData.data.vehicleName || '–'}</div></div>
        ${routeData.data.driverContact ? `
        <a href="https://t.me/${routeData.data.driverContact}" target="_blank" class="telegram-btn">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
            <path d="M9.78 18.65l.28-4.23 7.68-6.92c.34-.31-.07-.46-.52-.19L7.74 13.3 3.64 12c-.88-.25-.89-.86.18-1.27l17.6-6.79c1.04-.4 1.95.24 1.59 1.27l-3 17.49c-.23.99-1.07 1.24-1.92.77l-4.64-3.42-2.23 2.15c-.25.25-.46.46-.94.46z"/>
          </svg>
          Telegram orqali bog‘lanish
        </a>` : ''}
      </div>

      ${routeData.data.vehicleImages?.length ? `
      <div class="info-card">
        <h3>Transport rasmlari</h3>
        <div class="gallery">
          ${routeData.data.vehicleImages.map(src => `<img src="${src}" alt="Avtomobil">`).join('')}
        </div>
      </div>` : ''}

      ${ordersHTML}
    `;

    const disabled = role === 'DRIVER' || routeData.data.finished;
    actionBar.innerHTML = `
      <button class="book-btn" ${disabled ? 'disabled' : ''}>
        ${routeData.data.finished ? 'Reys yakunlangan' : role === 'DRIVER' ? 'Bu sizning reysingiz' : 'Chipta bron qilish'}
      </button>
    `;
    actionBar.style.display = 'block';

    if (!disabled) {
      actionBar.querySelector('button').onclick = () => location.href = `/orders/new-order?id=${routeId}`;
    }

  } catch (e) {
    err('Internet aloqasini tekshiring yoki keyinroq urining');
  }
})();
</script>

</body>
</html>