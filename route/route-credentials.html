<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Reys Tafsilotlari (Kengaytirilgan)</title>
<style>
    /* 1. GLOBAL & RESET */
    *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
    :root {
        --primary-color: #900000; /* To'q qizil/Bordo */
        --primary-light: #d32f2f;
        --secondary-color: #1f2937; /* To'q kulrang matn */
        --text-muted: #6b7280;
        --bg-color: #f3f4f6; /* Ochroq fon */
        --white-color: #fff;
        --shadow-elevation: 0 4px 12px rgba(0,0,0,.08);
        --border-radius-xl: 20px;
        --border-radius-lg: 12px;
    }
    body, html { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; color:var(--secondary-color); background:var(--bg-color); height:100%; overflow-x:hidden; line-height:1.5; }
    .loader { text-align:center; padding:120px 20px; font-size:18px; color:var(--text-muted); }

    /* 2. HEADER */
    .header { position:sticky; top:0; left:0; right:0; height:60px; background:var(--primary-color); color:var(--white-color); display:flex; align-items:center; padding:0 20px; box-shadow:0 3px 10px rgba(0,0,0,.15); z-index:1000; }
    .back-btn { background:none; border:none; width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:.2s; }
    .back-btn:active { transform:scale(.9); background:rgba(255,255,255,.1); }
    .back-btn svg { width:24px; height:24px; fill:var(--white-color); }
    .header h1 { font-size:18px; font-weight:700; margin-left:12px; }

    /* 3. MAIN CONTENT LAYOUT */
    .main { padding:20px 20px 100px; max-width:700px; margin:0 auto; display:grid; grid-template-columns:1fr; gap:16px; }

    /* 4. ROUTE HERO - Yo'nalish Boshlanmasi (Ixcham) */
    .route-hero { background:linear-gradient(145deg, var(--primary-color) 40%, var(--primary-light)); color:var(--white-color); padding:30px 20px; border-radius:var(--border-radius-xl); box-shadow:0 15px 30px rgba(144,0,0,.3); display:grid; grid-template-columns:1fr auto 1fr; align-items:center; text-align:center; }
    .route-segment { display:flex; flex-direction:column; align-items:center; }
    .route-city { font-size:26px; font-weight:900; line-height:1.2; }
    .route-code { font-size:12px; font-weight:500; opacity:0.8; margin-top:4px; }
    .route-icon { width:24px; height:24px; fill:var(--white-color); opacity:0.9; margin:0 10px; }

    /* 5. CARD SECTION - Ma'lumot Kartalari */
    .card-section { background:var(--white-color); border-radius:var(--border-radius-xl); padding:20px; box-shadow:var(--shadow-elevation); }
    .section-title { font-size:17px; font-weight:700; color:var(--primary-color); margin-bottom:15px; border-bottom:2px solid var(--bg-color); padding-bottom:10px; }

    /* 6. DATA GRID - Ma'lumotlar Setkasi (2 ustun) */
    .data-grid { display:grid; gap:10px; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); }
    .data-item { padding:10px 0; border-bottom:1px dashed #e5e7eb; display:flex; flex-direction:column; }
    .data-item:last-child { border-bottom:none; }
    .data-item-label { font-size:12px; font-weight:600; color:var(--text-muted); margin-bottom:2px; display:flex; align-items:center; text-transform:uppercase; }
    .data-item-label svg { width:16px; height:16px; fill:var(--primary-color); margin-right:6px; opacity:0.7; }
    .data-item-value { font-size:16px; font-weight:700; color:var(--secondary-color); line-height:1.2; }
    .data-grid > .data-item:nth-last-child(2),
    .data-grid > .data-item:last-child {
        border-bottom: none;
    }
    /* Bir ustunli elementlar uchun */
    .data-item.full-row { grid-column: 1 / -1; }

    /* 7. STATUS BADGE */
    .status-badge { display:inline-block; padding:6px 15px; border-radius:12px; font-weight:700; font-size:12px; margin-top:8px; text-transform:uppercase; }
    .status-badge.active { background:#dcfce7; color:#166534; }
    .status-badge.finished { background:#f8fafc; color:#475569; border:1px solid #e2e8f0; }

    /* 8. CONTACT & TELEGRAM */
    .contact-info { margin-top:10px; }
    .telegram-btn { display:inline-flex; align-items:center; gap:8px; background:#0088cc; color:var(--white-color); padding:10px 16px; border-radius:20px; font-weight:600; font-size:14px; box-shadow:0 3px 10px rgba(0,136,204,.2); transition:.2s; max-width:fit-content; }
    .telegram-btn:hover { background:#006ba1; transform:translateY(-1px); }
    .telegram-btn svg { width:18px; height:18px; fill:currentColor; }

    /* 9. GALLERY - Albom Ko'rinishi */
    .gallery-title { font-size:15px; font-weight:600; color:var(--secondary-color); margin-top:15px; margin-bottom:8px; }
    .gallery-container { display:grid; grid-template-columns:repeat(auto-fill,minmax(120px,1fr)); gap:8px; }
    .gallery-container img { width:100%; height:100px; object-fit:cover; border-radius:var(--border-radius-lg); box-shadow:0 2px 8px rgba(0,0,0,.1); }

    /* 10. ACTION BUTTON - Bron Qilish Tugmasi */
    .action-bar { position:fixed; bottom:0; left:0; right:0; background:var(--white-color); padding:10px 20px; box-shadow:0 -5px 15px rgba(0,0,0,.08); z-index:998; }
    .action-btn { width:100%; padding:14px; background:linear-gradient(90deg, var(--primary-color), var(--primary-light)); color:var(--white-color); border:none; border-radius:12px; font-size:17px; font-weight:800; letter-spacing:0.5px; box-shadow:0 5px 15px rgba(144,0,0,.3); cursor:pointer; transition:.3s; }
    .action-btn:hover:not(:disabled) { box-shadow:0 8px 20px rgba(144,0,0,.4); transform:translateY(-1px); }
    .action-btn:disabled { background:#ccc; background:linear-gradient(90deg, #9ca3af, #6b7280); color:#e5e7eb; cursor:not-allowed; box-shadow:none; }

    /* Mobile optimizatsiyasi */
    @media (max-width:480px){
        .route-city{font-size:22px}
        .main{padding:15px 15px 90px}
        .card-section{padding:15px; border-radius:16px;}
        .data-item{padding:8px 0;}
    }
</style>
</head>
<body>

<header class="header">
    <button class="back-btn" onclick="history.back()">
        <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
    </button>
    <h1>Reys Tafsilotlari</h1>
</header>

<main class="main">
    <div id="content" class="loader">Yuklanmoqda...</div>
</main>

<div id="action-bar-container" class="action-bar" style="display:none;">
    </div>

<script>
(async () => {
    // 1. O'zgaruvchilar va Boshlang'ich Sozlamalar
    const token = localStorage.getItem('token');
    const role = localStorage.getItem('role') || 'CLIENT'; // Agar topilmasa, standart holat - CLIENT
    if (!token) {
        // Agar token bo'lmasa, kirish sahifasiga yo'naltirish,
        // Lekin hozircha faqat kontentni yuklashga e'tibor beramiz
        // return location.href = '/login'; 
    }

    const routeId = new URLSearchParams(location.search).get('id');
    const contentEl = document.getElementById('content');
    const actionBarContainer = document.getElementById('action-bar-container');

    if (!routeId) {
        contentEl.innerHTML = '<div class="loader" style="color:#d32f2f">Reys identifikatori topilmadi</div>';
        return;
    }

    const showError = (msg='Ma\'lumotlarni yuklashda xatolik yuz berdi. Iltimos, keyinroq urinib ko\'ring.') => contentEl.innerHTML = `<div class="loader" style="color:#d32f2f">${msg}</div>`;

    // 2. Ma'lumotlarni API'dan yuklash
    try {
        const res = await fetch(`https://api.rout24.online/routes/${routeId}`, { headers:{Authorization:`Bearer ${token}`} });
        if (!res.ok) throw new Error();
        const { success, data } = await res.json();
        if (!success || !data) throw new Error();

        // 3. Ma'lumotlarni Formativlash
        const departureDate = new Date(data.departureDate);
        const fDate = departureDate.toLocaleDateString('uz-UZ', { year:'numeric', month:'long', day:'numeric' });
        const fTime = departureDate.toLocaleTimeString('uz-UZ', { hour:'2-digit', minute:'2-digit' });
        const fWeekday = departureDate.toLocaleDateString('uz-UZ', { weekday:'long' });

        const priceFormatted = data.price ? data.price.toLocaleString('uz-UZ') : 'Narx belgilanmagan';
        const driverContactHtml = data.driverContact ? `
            <div class="contact-info">
                <a href="https://t.me/${data.driverContact}" target="_blank" class="telegram-btn">
                    <svg viewBox="0 0 24 24"><path d="M9.78 18.65l.28-4.23 7.68-6.92c.34-.31-.07-.46-.52-.19L7.74 13.3 3.64 12c-.88-.25-.89-.86.18-1.27l17.6-6.79c1.04-.4 1.95.24 1.59 1.27l-3 17.49c-.23.99-1.07 1.24-1.92.77l-4.64-3.42-2.23 2.15c-.25.25-.46.46-.94.46z"/></svg>
                    Telegram: @${data.driverContact}
                </a>
            </div>
        ` : '';

        const vehicleGalleryHtml = data.vehicleImages?.length ? `
            <div class="gallery-title">Rasmlar:</div>
            <div class="gallery-container">
                ${data.vehicleImages.map(src=>`<img src="${src}" alt="Avtomobil rasmi" loading="lazy">`).join('')}
            </div>
        ` : '';

        // 4. HTML kontentini shakllantirish
        contentEl.innerHTML = `
        <div class="route-hero">
            <div class="route-segment">
                <div class="route-city">${data.from}</div>
                <div class="route-code">Ketish shahri</div>
            </div>
            <div class="route-icon">
                <svg viewBox="0 0 24 24"><path d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm1 16h-2v-2h2v2zm0-4h-2V7h2v7z"/></svg>
            </div>
            <div class="route-segment">
                <div class="route-city">${data.to}</div>
                <div class="route-code">Borish shahri</div>
            </div>
        </div>

        <div class="card-section" style="text-align:center;">
            <div class="section-title" style="border:none; text-align:center; padding:0; margin-bottom:5px;">Hozirgi Holati</div>
            <div class="status-badge ${data.finished?'finished':'active'}">${data.finished?'YAKUNLANGAN':'FAOL'}</div>
        </div>

        <div class="card-section">
            <div class="section-title">Reys Ma'lumotlari</div>
            <div class="data-grid">
                <div class="data-item">
                    <div class="data-item-label">
                        <svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zM5 9h14v11H5zM7 11h2v2H7z"/></svg>
                        Ketish Sanasi
                    </div>
                    <div class="data-item-value">${fDate} (${fWeekday})</div>
                </div>
                <div class="data-item">
                    <div class="data-item-label">
                        <svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zM12.5 7H11v6l5.25 3.15.75-1.23-4.5-2.62z"/></svg>
                        Ketish Vaqti
                    </div>
                    <div class="data-item-value">${fTime}</div>
                </div>
                <div class="data-item">
                    <div class="data-item-label">
                        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
                        Narx
                    </div>
                    <div class="data-item-value">${priceFormatted} so'm</div>
                </div>
                <div class="data-item">
                    <div class="data-item-label">
                        <svg viewBox="0 0 24 24"><path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-4c0 2.21 1.79 4 4 4 2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4zm16 12c0-2.66-5.33-4-8-4-2.67 0-8 1.34-8 4v2h16v-2z"/></svg>
                        Bo'sh joylar
                    </div>
                    <div class="data-item-value">${data.seatsCount} ta</div>
                </div>
            </div>
        </div>

        <div class="card-section">
            <div class="section-title">Manzillar Tafsiloti</div>
            <div class="data-grid">
                <div class="data-item full-row">
                    <div class="data-item-label">
                        <svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
                        Ketish manzili
                    </div>
                    <div class="data-item-value">${data.fromAddress}</div>
                </div>
                <div class="data-item full-row">
                    <div class="data-item-label">
                        <svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
                        Borish manzili
                    </div>
                    <div class="data-item-value">${data.toAddress}</div>
                </div>
            </div>
        </div>

        <div class="card-section">
            <div class="section-title">Haydovchi va Avtomobil</div>
            <div class="data-grid">
                <div class="data-item">
                    <div class="data-item-label">
                        <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                        Haydovchi
                    </div>
                    <div class="data-item-value">${data.driverFullName || 'Ma\'lumot kiritilmagan'}</div>
                </div>
                <div class="data-item">
                    <div class="data-item-label">
                        <svg viewBox="0 0 24 24"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM5 12l1.5-4.5h11L19 12H5z"/></svg>
                        Model
                    </div>
                    <div class="data-item-value">${data.vehicleName || 'Noma\'lum'}</div>
                </div>
            </div>
            ${driverContactHtml}
        </div>

        ${data.vehicleName ? `
        <div class="card-section">
            <div class="section-title">Transport Rasmlari</div>
            ${vehicleGalleryHtml}
        </div>` : ''}
        `;
        
        // 5. Bron Qilish Tugmasini Joylash va Cheklash Logikasi
        const isDriver = role === 'DRIVER';
        const isFinished = data.finished;
        
        const btnText = isFinished 
            ? 'Reys Yakunlangan' 
            : isDriver 
            ? "Haydovchilar Bron Qila Olishmaydi" 
            : 'Bron Qilish';
            
        const isDisabled = isDriver || isFinished;

        actionBarContainer.innerHTML = `
            <button class="action-btn" id="book-btn" ${isDisabled ? 'disabled' : ''}>
                ${btnText}
            </button>
        `;
        actionBarContainer.style.display = 'block';

        if (!isDisabled) {
            document.getElementById('book-btn').addEventListener('click', () => {
                location.href = `order.html?id=${routeId}`;
            });
        }

    } catch (e) {
        console.error(e);
        showError();
    }
})();
</script>

</body>
</html>