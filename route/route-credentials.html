<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Reys Tafsilotlari</title>
<style>
  :root {
    --primary: #d32f2f;
    --primary-dark: #b71c1c;
    --accent: #1976d2;
    --gray-100: #f8f9fa;
    --gray-200: #e9ecef;
    --gray-500: #6c757d;
    --gray-700: #343a40;
    --success: #10b981;
    --radius: 20px;
    --shadow: 0 8px 25px rgba(0,0,0,0.08);
    --transition: all 0.25s ease;
  }
  
  * { margin:0; padding:0; box-sizing:border-box; }
  body, html {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: #f1f3f5;
    color: var(--gray-700);
    min-height: 100vh;
    line-height: 1.5;
  }

  .header {
    position: sticky;
    top: 0;
    height: 64px;
    background: var(--primary);
    color: white;
    display: flex;
    align-items: center;
    padding: 0 16px;
    z-index: 100;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }

  .back-btn {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: rgba(255,255,255,0.15);
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: var(--transition);
  }
  .back-btn:active { background: rgba(255,255,255,0.3); transform: scale(0.94); }

  .header h1 {
    font-size: 19px;
    font-weight: 700;
    margin-left: 12px;
  }

  .main {
    padding: 16px;
    padding-bottom: 100px;
    max-width: 600px;
    margin: 0 auto;
  }

  .hero {
    background: white;
    border-radius: var(--radius);
    padding: 24px 20px;
    text-align: center;
    box-shadow: var(--shadow);
    margin-bottom: 16px;
    position: relative;
    overflow: hidden;
  }

  .cities {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin: 12px 0 20px;
  }

  .city {
    flex: 1;
  }

  .city-name {
    font-size: 26px;
    font-weight: 800;
    color: var(--primary);
  }

  .city-label {
    font-size: 12px;
    color: var(--gray-500);
    margin-top: 4px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .arrow {
    width: 36px;
    height: 36px;
    background: var(--gray-200);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 12px;
  }

  .status {
    display: inline-block;
    padding: 6px 16px;
    border-radius: 30px;
    font-size: 13px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .status.active { background: #d1fae5; color: #065f46; }
  .status.finished { background: var(--gray-200); color: var(--gray-700); }

  .card {
    background: white;
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 16px;
    box-shadow: var(--shadow);
  }

  .card-title {
    font-size: 17px;
    font-weight: 700;
    color: var(--gray-700);
    margin-bottom: 16px;
    padding-bottom: 8px;
    border-bottom: 2px solid var(--primary);
    display: inline-block;
  }

  .info-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px 0;
    border-bottom: 1px solid var(--gray-200);
  }
  .info-row:last-child { border-bottom: none; }

  .info-label {
    font-size: 15px;
    color: var(--gray-500);
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .info-value {
    font-size: 16px;
    font-weight: 700;
    color: var(--gray-700);
    text-align: right;
  }

  .gallery {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 12px;
    margin-top: 8px;
  }

  .gallery img {
    width: 100%;
    height: 100px;
    object-fit: cover;
    border-radius: 14px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  }

  .telegram-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    background: #0088cc;
    color: white;
    padding: 12px 20px;
    border-radius: 30px;
    font-weight: 700;
    font-size: 14px;
    margin-top: 16px;
    text-decoration: none;
    transition: var(--transition);
  }
  .telegram-btn:active { transform: scale(0.96); }

  .action-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    padding: 16px;
    padding-bottom: max(16px, env(safe-area-inset-bottom));
    box-shadow: 0 -4px 20px rgba(0,0,0,0.12);
    z-index: 99;
  }

  .book-btn {
    width: 100%;
    padding: 18px;
    background: linear-gradient(90deg, var(--primary), var(--primary-dark));
    color: white;
    border: none;
    border-radius: var(--radius);
    font-size: 18px;
    font-weight: 800;
    letter-spacing: 0.5px;
    cursor: pointer;
    transition: var(--transition);
    box-shadow: 0 6px 15px rgba(211,47,47,0.3);
  }

  .book-btn:active { transform: translateY(2px); box-shadow: 0 4px 10px rgba(211,47,47,0.3); }
  .book-btn:disabled {
    background: #aaa;
    box-shadow: none;
    cursor: not-allowed;
  }

  .loader {
    text-align: center;
    padding: 80px 20px;
    font-size: 18px;
    color: var(--gray-500);
  }
</style>
</head>
<body>

<header class="header">
  <button class="back-btn" onclick="history.back()">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
      <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
    </svg>
  </button>
  <h1>Reys Tafsilotlari</h1>
</header>

<main class="main" id="main">
  <div class="loader">Yuklanmoqda...</div>
</main>

<div class="action-bar" id="action-bar" style="display:none"></div>

<script>
(async () => {
  const token = localStorage.getItem('token');
  const role = localStorage.getItem('role') || 'CLIENT';
  const routeId = new URLSearchParams(location.search).get('id');
  const main = document.getElementById('main');
  const actionBar = document.getElementById('action-bar');

  if (!routeId) {
    main.innerHTML = '<div class="loader" style="color:var(--primary)">Reys ID topilmadi</div>';
    return;
  }

  const showError = (msg) => main.innerHTML = `<div class="loader" style="color:var(--primary)">${msg}</div>`;

  try {
    const res = await fetch(`https://api.rout24.online/routes/${routeId}`, {
      headers: { Authorization: `Bearer ${token}` }
    });

    if (!res.ok) throw new Error();
    const { success, data } = await res.json();
    if (!success || !data) throw new Error();

    const dep = new Date(data.departureDate);
    const dateStr = dep.toLocaleDateString('uz-UZ', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    const timeStr = dep.toLocaleTimeString('uz-UZ', { hour: '2-digit', minute: '2-digit' });
    const priceStr = data.price ? data.price.toLocaleString('uz-UZ') + " so‘m" : "Noma’lum";

    main.innerHTML = `
      <!-- HERO -->
      <div class="hero">
        <div class="cities">
          <div class="city">
            <div class="city-name">${data.from}</div>
            <div class="city-label">Ketish</div>
          </div>
          <div class="arrow">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="#666">
              <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6z"/>
            </svg>
          </div>
          <div class="city">
            <div class="city-name">${data.to}</div>
            <div class="city-label">Yetib borish</div>
          </div>
        </div>
        <div class="status ${data.finished ? 'finished' : 'active'}">
          ${data.finished ? 'Yakunlangan' : 'Faol'}
        </div>
      </div>

      <!-- REYS MA'LUMOTLARI -->
      <div class="card">
        <div class="card-title">Reys ma'lumotlari</div>
        <div class="info-row">
          <div class="info-label">Sana</div>
          <div class="info-value">${dateStr}</div>
        </div>
        <div class="info-row">
          <div class="info-label">Vaqt</div>
          <div class="info-value">${timeStr}</div>
        </div>
        <div class="info-row">
          <div class="info-label">Narx</div>
          <div class="info-value">${priceStr}</div>
        </div>
        <div class="info-row">
          <div class="info-label">Bo'sh o'rindiqlar</div>
          <div class="info-value">${data.seatsCount} ta</div>
        </div>
      </div>

      <!-- MANZILLAR -->
      <div class="card">
        <div class="card-title">Manzillar</div>
        <div class="info-row">
          <div class="info-label">Ketish joyi</div>
          <div class="info-value">${data.fromAddress}</div>
        </div>
        <div class="info-row">
          <div class="info-label">Borish joyi</div>
          <div class="info-value">${data.toAddress}</div>
        </div>
      </div>

      <!-- HAYDOVCHI -->
      <div class="card">
        <div class="card-title">Haydovchi va transport</div>
        <div class="info-row">
          <div class="info-label">F.I.Sh.</div>
          <div class="info-value">${data.driverFullName || 'Ma’lumot yo‘q'}</div>
        </div>
        <div class="info-row">
          <div class="info-label">Transport</div>
          <div class="info-value">${data.vehicleName || 'Noma’lum'}</div>
        </div>
        ${data.driverContact ? `
        <a href="https://t.me/${data.driverContact}" target="_blank" class="telegram-btn">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M9.78 18.65l.28-4.23 7.68-6.92c.34-.31-.07-.46-.52-.19L7.74 13.3 3.64 12c-.88-.25-.89-.86.18-1.27l17.6-6.79c1.04-.4 1.95.24 1.59 1.27l-3 17.49c-.23.99-1.07 1.24-1.92.77l-4.64-3.42-2.23 2.15c-.25.25-.46.46-.94.46z"/>
          </svg>
          Telegram orqali yozish
        </a>` : ''}
      </div>

      ${data.vehicleImages?.length ? `
      <div class="card">
        <div class="card-title">Transport rasmlari</div>
        <div class="gallery">
          ${data.vehicleImages.map(src => `<img src="${src}" alt="Transport">`).join('')}
        </div>
      </div>` : ''}
    `;

    // Tugma
    const isDriver = role === 'DRIVER';
    const disabled = isDriver || data.finished;

    actionBar.innerHTML = `
      <button class="book-btn" id="bookBtn" ${disabled ? 'disabled' : ''}>
        ${data.finished ? 'Reys yakunlangan' : isDriver ? 'Siz haydovchisiz' : 'Chipta bron qilish'}
      </button>
    `;
    actionBar.style.display = 'block';

    if (!disabled) {
      document.getElementById('bookBtn').onclick = () => {
        location.href = `order.html?id=${routeId}`;
      };
    }

  } catch (e) {
    showError('Ma’lumot yuklanmadi. Internetni tekshiring.');
  }
})();
</script>

</body>
</html>