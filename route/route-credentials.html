<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Reys Tafsilotlari</title>
<style>
    /* 1. GLOBAL & RESET */
    *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
    :root {
        --primary-color: #900000; /* Bordo / Qizil */
        --primary-light: #d32f2f;
        --accent-color: #1d4ed8; /* Ko'k rang (Ikkinchi rang) */
        --secondary-color: #1f2937;
        --text-muted: #6b7280;
        --bg-color: #f7f7f7;
        --white-color: #fff;
        --shadow-card: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
        --border-radius-xl: 16px;
        --border-radius-lg: 10px;
    }
    body, html { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; color:var(--secondary-color); background:var(--bg-color); height:100%; overflow-x:hidden; line-height:1.4; }
    .loader { text-align:center; padding:120px 20px; font-size:18px; color:var(--text-muted); }

    /* 2. HEADER (App Bar) */
    .header { position:sticky; top:0; left:0; right:0; height:56px; background:var(--primary-color); color:var(--white-color); display:flex; align-items:center; padding:0 16px; box-shadow:0 2px 4px rgba(0,0,0,.15); z-index:1000; }
    .back-btn { background:none; border:none; width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:.2s; }
    .back-btn:active { background:rgba(255,255,255,.1); }
    .back-btn svg { width:24px; height:24px; fill:var(--white-color); }
    .header h1 { font-size:17px; font-weight:600; margin-left:12px; }

    /* 3. MAIN CONTENT LAYOUT */
    .main { padding:16px 16px 90px; max-width:600px; margin:0 auto; display:flex; flex-direction:column; gap:12px; }

    /* 4. ROUTE HERO - Yo'nalish Boshlanmasi */
    .route-hero { background:var(--white-color); padding:18px; border-radius:var(--border-radius-xl); box-shadow:var(--shadow-card); display:grid; grid-template-columns:1fr 20px 1fr; align-items:center; text-align:center; position:relative; }
    .route-segment { display:flex; flex-direction:column; align-items:center; }
    .route-city { font-size:20px; font-weight:800; line-height:1.2; color:var(--primary-color); }
    .route-code { font-size:11px; font-weight:500; color:var(--text-muted); margin-top:4px; text-transform:uppercase; }
    .route-icon { width:20px; height:20px; fill:var(--text-muted); opacity:0.6; }
    .route-icon svg { margin-top: 10px; }
    
    .status-area { text-align:center; margin-top: 5px; grid-column: 1 / -1; }
    .status-badge { padding: 4px 10px; border-radius: 12px; font-weight: 700; font-size: 11px; text-transform: uppercase; }
    .status-badge.active { background:#d1fae5; color:#065f46; }
    .status-badge.finished { background:#e5e7eb; color:#4b5563; }

    /* 5. CARD SECTION - Ma'lumot Kartalari */
    .card-section { background:var(--white-color); border-radius:var(--border-radius-xl); padding:16px; box-shadow:var(--shadow-card); }
    .section-title { font-size:16px; font-weight:700; color:var(--secondary-color); margin-bottom:12px; border-left:3px solid var(--primary-color); padding-left:10px; line-height:1; }

    /* 6. DATA LIST (Eng samarali ko'rinish) */
    .data-list { display:flex; flex-direction:column; gap:0; }
    .data-item { display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid #f3f4f6; }
    .data-item:last-child { border-bottom:none; }
    .data-item-label { font-size:14px; font-weight:500; color:var(--text-muted); display:flex; align-items:center; }
    .data-item-label svg { width:18px; height:18px; fill:var(--accent-color); margin-right:8px; opacity:0.8; }
    .data-item-value { font-size:15px; font-weight:600; color:var(--secondary-color); text-align:right; }

    /* 7. DRIVER & CONTACT */
    .driver-contact-link { display:inline-flex; align-items:center; gap:8px; background:#0088cc; color:var(--white-color); padding:8px 14px; border-radius:20px; font-weight:600; font-size:13px; margin-top:10px; box-shadow:0 2px 5px rgba(0,136,204,.2); }
    .driver-contact-link svg { width:16px; height:16px; fill:currentColor; }

    /* 8. GALLERY - Albom Ko'rinishi (Kichikroq) */
    .gallery-container { display:grid; grid-template-columns:repeat(auto-fill,minmax(100px,1fr)); gap:8px; margin-top:10px; }
    .gallery-container img { width:100%; height:80px; object-fit:cover; border-radius:var(--border-radius-lg); box-shadow:0 1px 4px rgba(0,0,0,.1); }

    /* 9. ACTION BUTTON (Pastki Panel) */
    .action-bar { position:fixed; bottom:0; left:0; right:0; background:var(--white-color); padding:12px 16px; box-shadow:0 -2px 8px rgba(0,0,0,.1); z-index:998; }
    .action-btn { width:100%; padding:14px; background:linear-gradient(90deg, var(--primary-color), var(--primary-light)); color:var(--white-color); border:none; border-radius:12px; font-size:16px; font-weight:700; transition:.3s; }
    .action-btn:hover:not(:disabled) { box-shadow:0 4px 10px rgba(144,0,0,.3); transform:translateY(-1px); }
    .action-btn:disabled { background:#a0aec0; color:#e2e8f0; cursor:not-allowed; box-shadow:none; }
</style>
</head>
<body>

<header class="header">
    <button class="back-btn" onclick="history.back()">
        <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
    </button>
    <h1>Reys Tafsilotlari</h1>
</header>

<main class="main">
    <div id="content" class="loader">Yuklanmoqda...</div>
</main>

<div id="action-bar-container" class="action-bar" style="display:none;">
    </div>

<script>
(async () => {
    // 1. O'zgaruvchilar va Boshlang'ich Sozlamalar
    const token = localStorage.getItem('token');
    const role = localStorage.getItem('role') || 'CLIENT';
    const routeId = new URLSearchParams(location.search).get('id');
    const contentEl = document.getElementById('content');
    const actionBarContainer = document.getElementById('action-bar-container');

    if (!routeId) {
        contentEl.innerHTML = `<div class="loader" style="color:var(--primary-light)">Reys identifikatori topilmadi</div>`;
        return;
    }

    const showError = (msg='Ma\'lumotlarni yuklashda xatolik yuz berdi.') => contentEl.innerHTML = `<div class="loader" style="color:var(--primary-light)">${msg}</div>`;

    // 2. Ma'lumotlarni API'dan yuklash
    try {
        const res = await fetch(`https://api.rout24.online/routes/${routeId}`, { headers:{Authorization:`Bearer ${token}`} });
        if (!res.ok) throw new Error();
        const { success, data } = await res.json();
        if (!success || !data) throw new Error();

        // 3. Ma'lumotlarni Formativlash
        const departureDate = new Date(data.departureDate);
        const fDate = departureDate.toLocaleDateString('uz-UZ', { year:'numeric', month:'long', day:'numeric' });
        const fTime = departureDate.toLocaleTimeString('uz-UZ', { hour:'2-digit', minute:'2-digit' });
        const fWeekday = departureDate.toLocaleDateString('uz-UZ', { weekday:'long' });

        const priceFormatted = data.price ? data.price.toLocaleString('uz-UZ') : 'Noma\'lum';
        
        // 4. HTML kontentini shakllantirish
        contentEl.innerHTML = `
        <div class="route-hero">
            <div class="route-segment">
                <div class="route-city">${data.from}</div>
                <div class="route-code">Ketish shahri</div>
            </div>
            <div class="route-icon">
                <svg viewBox="0 0 24 24"><path d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm-1 15h2v-2h-2v2zm0-4h2V7h-2v6z"/></svg>
            </div>
            <div class="route-segment">
                <div class="route-city">${data.to}</div>
                <div class="route-code">Borish shahri</div>
            </div>
            <div class="status-area">
                <div class="status-badge ${data.finished?'finished':'active'}">${data.finished?'YAKUNLANGAN':'FAOL REYS'}</div>
            </div>
        </div>

        <div class="card-section">
            <div class="section-title">Reys Ma'lumotlari</div>
            <div class="data-list">
                <div class="data-item">
                    <div class="data-item-label">
                        <svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zM5 9h14v11H5z"/></svg>
                        Sana
                    </div>
                    <div class="data-item-value">${fDate} (${fWeekday})</div>
                </div>
                <div class="data-item">
                    <div class="data-item-label">
                        <svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12.5 7H11v6l5.25 3.15.75-1.23-4.5-2.62z"/></svg>
                        Vaqt
                    </div>
                    <div class="data-item-value">${fTime}</div>
                </div>
                <div class="data-item">
                    <div class="data-item-label">
                        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
                        Chipta Narxi
                    </div>
                    <div class="data-item-value">${priceFormatted} so'm</div>
                </div>
                <div class="data-item">
                    <div class="data-item-label">
                        <svg viewBox="0 0 24 24"><path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-4c0 2.21 1.79 4 4 4 2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4zm16 12c0-2.66-5.33-4-8-4-2.67 0-8 1.34-8 4v2h16v-2z"/></svg>
                        Bo'sh joylar
                    </div>
                    <div class="data-item-value">${data.seatsCount} ta</div>
                </div>
            </div>
        </div>

        <div class="card-section">
            <div class="section-title">Manzillar</div>
            <div class="data-list">
                <div class="data-item">
                    <div class="data-item-label">
                        <svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
                        Ketish manzili
                    </div>
                    <div class="data-item-value">${data.fromAddress}</div>
                </div>
                <div class="data-item">
                    <div class="data-item-label">
                        <svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
                        Borish manzili
                    </div>
                    <div class="data-item-value">${data.toAddress}</div>
                </div>
            </div>
        </div>

        <div class="card-section">
            <div class="section-title">Haydovchi va Transport</div>
            <div class="data-list">
                <div class="data-item">
                    <div class="data-item-label">
                        <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                        Haydovchi F.I.Sh.
                    </div>
                    <div class="data-item-value">${data.driverFullName || 'Ma\'lumot kiritilmagan'}</div>
                </div>
                <div class="data-item">
                    <div class="data-item-label">
                        <svg viewBox="0 0 24 24"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM5 12l1.5-4.5h11L19 12H5z"/></svg>
                        Mashina Modeli
                    </div>
                    <div class="data-item-value">${data.vehicleName || 'Noma\'lum'}</div>
                </div>
            </div>
            ${data.driverContact ? `
                <div style="margin-top:10px;">
                    <a href="https://t.me/${data.driverContact}" target="_blank" class="driver-contact-link">
                        <svg viewBox="0 0 24 24"><path d="M9.78 18.65l.28-4.23 7.68-6.92c.34-.31-.07-.46-.52-.19L7.74 13.3 3.64 12c-.88-.25-.89-.86.18-1.27l17.6-6.79c1.04-.4 1.95.24 1.59 1.27l-3 17.49c-.23.99-1.07 1.24-1.92.77l-4.64-3.42-2.23 2.15c-.25.25-.46.46-.94.46z"/></svg>
                        Telegram orqali bog'lanish
                    </a>
                </div>
            ` : ''}
        </div>

        ${data.vehicleImages?.length ? `
        <div class="card-section">
            <div class="section-title">Transport Rasmlari (Albom)</div>
            <div class="gallery-container">
                ${data.vehicleImages.map(src=>`<img src="${src}" alt="Avtomobil rasmi" loading="lazy">`).join('')}
            </div>
        </div>` : ''}
        `;
        
        // 5. Bron Qilish Tugmasini Joylash va Cheklash Logikasi
        const isDriver = role === 'DRIVER';
        const isFinished = data.finished;
        
        let btnText;
        if (isFinished) {
            btnText = 'Reys Yakunlangan';
        } else if (isDriver) {
            btnText = "Haydovchilar Bron Qila Olishmaydi";
        } else {
            btnText = 'Chipta Bron Qilish';
        }
            
        const isDisabled = isDriver || isFinished;

        actionBarContainer.innerHTML = `
            <button class="action-btn" id="book-btn" ${isDisabled ? 'disabled' : ''}>
                ${btnText}
            </button>
        `;
        actionBarContainer.style.display = 'block';

        if (!isDisabled) {
            document.getElementById('book-btn').addEventListener('click', () => {
                location.href = `order.html?id=${routeId}`;
            });
        }

    } catch (e) {
        console.error("Yuklash xatosi:", e);
        showError();
    }
})();
</script>

</body>
</html>