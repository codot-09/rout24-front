<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Reys Tafsilotlari</title>
<style>
    /* 1. GLOBAL RESET & BASE */
    *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
    :root {
        --primary-color: #800000; /* To'q qizil/Bordo */
        --primary-light: #c62828;
        --secondary-color: #0f172a;
        --text-muted: #64748b;
        --bg-color: #f8fafc;
        --white-color: #fff;
        --shadow-light: 0 10px 30px rgba(0,0,0,.08);
        --shadow-bold: 0 20px 50px rgba(128,0,0,.4);
        --border-radius-large: 28px;
        --border-radius-medium: 16px;
    }
    body, html { font-family:-apple-system, BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; color:var(--secondary-color); background:var(--bg-color); height:100%; overflow-x:hidden; line-height:1.4; }
    a { text-decoration: none; color: inherit; }
    .loader { text-align:center; padding:140px 20px; font-size:19px; color:#94a3b8; }

    /* 2. HEADER */
    .header { position:fixed; top:0; left:0; right:0; height:74px; background:var(--primary-color); color:var(--white-color); display:flex; align-items:center; padding:0 20px; box-shadow:0 5px 20px rgba(128,0,0,.15); z-index:1000; }
    .back-btn { background:none; border:none; width:48px; height:48px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:.3s; }
    .back-btn:active { transform:scale(.92); background:rgba(255,255,255,.12); }
    .back-btn svg { width:28px; height:28px; fill:var(--white-color); }
    .header h1 { font-size:22px; font-weight:800; margin-left:12px; }

    /* 3. MAIN CONTENT LAYOUT */
    .main { padding:90px 20px 140px; max-width:800px; margin:0 auto; }

    /* 4. ROUTE HERO - Yo'nalish Boshlanmasi */
    .route-hero { background:var(--white-color); padding:32px 24px; border-radius:var(--border-radius-large); max-width:640px; margin:0 auto 36px; box-shadow:var(--shadow-light); display:flex; flex-direction:column; align-items:center; }
    .route-segment { display:flex; flex-direction:column; align-items:center; width:100%; text-align:center; }
    .route-code { font-size:16px; font-weight:600; color:var(--primary-color); letter-spacing:1px; margin-bottom:4px; }
    .route-city { font-size:32px; font-weight:900; line-height:1.2; }
    .route-icon { margin:16px 0; width:40px; height:40px; fill:var(--primary-color); opacity:0.8; }
    .route-icon svg { width:100%; height:100%; }
    .route-segment:first-child .route-city { color:var(--primary-color); }

    /* 5. CARD SECTION - Ma'lumot Kartalari */
    .card-section { background:var(--white-color); border-radius:var(--border-radius-large); padding:28px; margin-bottom:24px; box-shadow:var(--shadow-light); }
    .section-title { font-size:20px; font-weight:800; color:var(--primary-color); margin-bottom:20px; border-left:4px solid var(--primary-color); padding-left:12px; line-height:1; }

    /* 6. DATA GRID - Ma'lumotlar Setkasi */
    .data-grid { display:grid; gap:16px; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); }
    .data-item { background:var(--bg-color); border-radius:var(--border-radius-medium); padding:16px; display:flex; flex-direction:column; transition:.3s; border:1px solid #e2e8f0; }
    .data-item.full-width { grid-column: 1 / -1; }
    .data-item-label { font-size:14px; font-weight:600; color:var(--text-muted); margin-bottom:4px; display:flex; align-items:center; }
    .data-item-label svg { width:18px; height:18px; fill:var(--primary-color); margin-right:8px; opacity:0.7; }
    .data-item-value { font-size:18px; font-weight:700; color:var(--secondary-color); line-height:1.3; }

    /* 7. STATUS BADGE */
    .status-badge { display:inline-block; padding:8px 20px; border-radius:40px; font-weight:800; font-size:14px; margin-top:10px; text-transform:uppercase; }
    .status-badge.active { background:#dcfce7; color:#166534; }
    .status-badge.finished { background:#f8fafc; color:#475569; border:2px solid #e2e8f0; }

    /* 8. DRIVER CONTACT */
    .contact-info { display:flex; flex-direction:column; gap:10px; margin-top:12px; }
    .telegram-btn { display:inline-flex; align-items:center; gap:10px; background:#0088cc; color:var(--white-color); padding:12px 20px; border-radius:30px; font-weight:700; font-size:15px; text-decoration:none; box-shadow:0 5px 15px rgba(0,136,204,.25); transition:.3s; max-width:fit-content; }
    .telegram-btn:hover { background:#006ba1; transform:translateY(-1px); }
    .telegram-btn svg { width:20px; height:20px; fill:currentColor; }

    /* 9. GALLERY */
    .gallery { display:grid; grid-template-columns:repeat(auto-fill,minmax(140px,1fr)); gap:12px; margin-top:20px; }
    .gallery img { width:100%; height:140px; object-fit:cover; border-radius:var(--border-radius-medium); box-shadow:0 5px 15px rgba(0,0,0,.1); transition:.3s; cursor:zoom-in; }
    .gallery img:hover { transform:translateY(-2px); box-shadow:0 8px 20px rgba(0,0,0,.15); }

    /* 10. ACTION BUTTON - Bron Qilish Tugmasi */
    .action-btn { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); width:calc(100% - 40px); max-width:480px; padding:18px; background:linear-gradient(135deg,var(--primary-color),var(--primary-light)); color:var(--white-color); border:none; border-radius:28px; font-size:19px; font-weight:900; letter-spacing:0.5px; box-shadow:var(--shadow-bold); cursor:pointer; z-index:999; transition:.4s; text-align:center; }
    .action-btn:hover { transform:translateX(-50%) translateY(-4px); box-shadow:0 25px 60px rgba(128,0,0,.5); }
    .action-btn:active { transform:translateX(-50%) scale(.96); }

    /* 11. MEDIA QUERIES - Mobilga Moslashuvchanlik */
    @media (max-width:480px){
        .main{padding:80px 16px 120px}
        .route-hero{padding:28px 16px; margin:0 auto 30px}
        .route-city{font-size:28px}
        .card-section{padding:24px}
        .data-grid{grid-template-columns:1fr}
        .action-btn{font-size:18px; padding:16px; bottom:16px;}
        .section-title { font-size:18px; }
    }
</style>
</head>
<body>

<header class="header">
    <button class="back-btn" onclick="history.back()">
        <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
    </button>
    <h1>Reys Tafsilotlari</h1>
</header>

<main class="main">
    <div id="content" class="loader">Yuklanmoqda...</div>
</main>

<script>
(async () => {
    // 1. O'zgaruvchilar va Boshlang'ich Sozlamalar
    const token = localStorage.getItem('token');
    // ROLE: CLIENT - Bron qila oladi; DRIVER - Bron qila olmaydi
    const role = localStorage.getItem('role') || 'CLIENT'; 
    if (!token) return location.href = '/login';

    const routeId = new URLSearchParams(location.search).get('id');
    const contentEl = document.getElementById('content');
    if (!routeId) {
        contentEl.innerHTML = '<div class="loader" style="color:#c62828">Reys identifikatori topilmadi</div>';
        return;
    }

    const showError = (msg='Ma\'lumotlarni yuklashda xatolik yuz berdi. Iltimos, keyinroq urinib ko\'ring.') => contentEl.innerHTML = `<div class="loader" style="color:#c62828">${msg}</div>`;

    // 2. Ma'lumotlarni API'dan yuklash
    try {
        const res = await fetch(`https://api.rout24.online/routes/${routeId}`, { headers:{Authorization:`Bearer ${token}`} });
        if (!res.ok) throw new Error();
        const { success, data } = await res.json();
        if (!success || !data) throw new Error();

        // 3. Ma'lumotlarni Formativlash
        const departureDate = new Date(data.departureDate);
        const fDate = departureDate.toLocaleDateString('uz-UZ', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
        const fTime = departureDate.toLocaleTimeString('uz-UZ', { hour:'2-digit', minute:'2-digit' });

        const priceFormatted = data.price ? data.price.toLocaleString('uz-UZ') + " so'm" : 'Narx belgilanmagan';
        const driverContactHtml = data.driverContact ? `
            <a href="https://t.me/${data.driverContact}" target="_blank" class="telegram-btn">
                <svg viewBox="0 0 24 24"><path d="M9.78 18.65l.28-4.23 7.68-6.92c.34-.31-.07-.46-.52-.19L7.74 13.3 3.64 12c-.88-.25-.89-.86.18-1.27l17.6-6.79c1.04-.4 1.95.24 1.59 1.27l-3 17.49c-.23.99-1.07 1.24-1.92.77l-4.64-3.42-2.23 2.15c-.25.25-.46.46-.94.46z"/></svg>
                @${data.driverContact}
            </a>
        ` : '';

        const vehicleGalleryHtml = data.vehicleImages?.length ? `
            <div class="gallery">
                ${data.vehicleImages.map(src=>`<img src="${src}" alt="Transport vositasi rasmi" loading="lazy">`).join('')}
            </div>
        ` : '<div><p style="color:var(--text-muted); font-size:14px; margin-top:10px;">Mashina rasmlari kiritilmagan.</p></div>';


        const bookBtnHtml = role === 'CLIENT' && !data.finished
            ? `<button class="action-btn" onclick="location.href='order.html?id=${routeId}'">Bron Qilish</button>`
            : '';

        // 4. HTML kontentini shakllantirish (Zamonaviy dizayn va Data Grid ishlatilgan)
        contentEl.innerHTML = `
        <div class="route-hero">
            <div class="route-segment">
                <div class="route-code">KETISH NUQTASI</div>
                <div class="route-city">${data.from}</div>
            </div>
            <div class="route-icon">
                <svg viewBox="0 0 24 24"><path d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm1 16h-2v-2h2v2zm0-4h-2V7h2v7z"/></svg>
            </div>
            <div class="route-segment">
                <div class="route-code">BORISH MANZILI</div>
                <div class="route-city">${data.to}</div>
            </div>
        </div>

        <div class="card-section" style="text-align:center;">
            <div class="section-title" style="border:none; text-align:center; padding:0;">Reys Statusi</div>
            <div class="status-badge ${data.finished?'finished':'active'}">${data.finished?'Yakunlangan':'Faol'}</div>
        </div>

        <div class="card-section">
            <div class="section-title">Manzillar Tafsiloti</div>
            <div class="data-grid">
                <div class="data-item full-width">
                    <div class="data-item-label">
                        <svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
                        Ketish manzili
                    </div>
                    <div class="data-item-value">${data.fromAddress}</div>
                </div>
                <div class="data-item full-width">
                    <div class="data-item-label">
                        <svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
                        Borish manzili
                    </div>
                    <div class="data-item-value">${data.toAddress}</div>
                </div>
            </div>
        </div>

        <div class="card-section">
            <div class="section-title">Asosiy Ma'lumotlar</div>
            <div class="data-grid">
                <div class="data-item">
                    <div class="data-item-label">
                        <svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11zM7 11h2v2H7z"/></svg>
                        Ketish Sanasi
                    </div>
                    <div class="data-item-value">${fDate}</div>
                </div>
                <div class="data-item">
                    <div class="data-item-label">
                        <svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zM12.5 7H11v6l5.25 3.15.75-1.23-4.5-2.62z"/></svg>
                        Ketish Vaqti
                    </div>
                    <div class="data-item-value">${fTime}</div>
                </div>
                <div class="data-item">
                    <div class="data-item-label">
                        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
                        Chipta Narxi
                    </div>
                    <div class="data-item-value">${priceFormatted}</div>
                </div>
                <div class="data-item">
                    <div class="data-item-label">
                        <svg viewBox="0 0 24 24"><path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-4c0 2.21 1.79 4 4 4 2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4zm16 12c0-2.66-5.33-4-8-4-2.67 0-8 1.34-8 4v2h16v-2z"/></svg>
                        Bo'sh O'rinlar
                    </div>
                    <div class="data-item-value">${data.seatsCount} ta</div>
                </div>
            </div>
        </div>

        <div class="card-section">
            <div class="section-title">Haydovchi</div>
            <div class="data-grid">
                <div class="data-item full-width">
                    <div class="data-item-label">
                        <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                        Ism familiyasi
                    </div>
                    <div class="data-item-value">${data.driverFullName || 'Ma\'lumot kiritilmagan'}</div>
                </div>
            </div>
            ${data.driverContact ? `<div class="contact-info">${driverContactHtml}</div>` : ''}
        </div>

        ${data.vehicleName ? `
        <div class="card-section">
            <div class="section-title">Transport Vositasining Ma'lumotlari</div>
            <div class="data-grid">
                <div class="data-item full-width">
                    <div class="data-item-label">
                        <svg viewBox="0 0 24 24"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 17c-.83 0-1.5-.67-1.5-1.5S5.67 14 6.5 14s1.5.67 1.5 1.5S7.33 17 6.5 17zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 12l1.5-4.5h11L19 12H5z"/></svg>
                        Mashina modeli
                    </div>
                    <div class="data-item-value">${data.vehicleName}</div>
                </div>
            </div>
            ${data.vehicleImages?.length ? vehicleGalleryHtml : ''}
        </div>` : ''}

        ${bookBtnHtml}
        `;
    } catch (e) {
        console.error(e);
        showError();
    }
})();
</script>

</body>
</html>