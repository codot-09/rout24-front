<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yangi reys yaratish</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{
            font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
            background:#f8f9fa;
            min-height:100vh;
        }
        .header{
            position:fixed;top:0;left:0;right:0;height:74px;
            background:#800000;color:#fff;display:flex;align-items:center;
            padding:0 16px;box-shadow:0 4px 20px rgba(0,0,0,0.1);z-index:1000;
        }
        .back-btn{
            background:none;border:none;color:#fff;width:48px;height:48px;
            border-radius:50%;display:flex;align-items:center;justify-content:center;
            font-size:28px;cursor:pointer;
        }
        .back-btn:hover{ background:rgba(255,255,255,0.15); }
        .header h1{ font-size:22px; font-weight:700; margin-left:12px; }

        .container{
            padding:90px 20px 20px;
            max-width:600px;
            margin:0 auto;
        }
        .card{
            background:#fff;
            border-radius:20px;
            overflow:hidden;
            box-shadow:0 10px 40px rgba(128,0,0,0.12);
        }
        .form{padding:28px}
        label{
            display:block;margin:20px 0 8px;
            font-weight:600;color:#333;font-size:15px;
        }
        select, input[type=number], input[type=datetime-local]{
            width:100%;padding:14px 16px;
            border:2px solid #eee;border-radius:12px;
            font-size:16px;transition:border 0.3s;
        }
        select:focus, input:focus{
            outline:none;border-color:#800000;
            box-shadow:0 0 0 4px rgba(128,0,0,0.1);
        }
        #map{
            height:400px;
            border-radius:16px;
            margin:24px 0;
            border:3px solid #ddd;
        }
        .status{
            text-align:center;padding:16px;
            background:#fff8e1;border-radius:12px;
            font-weight:600;color:#d84315;margin-bottom:20px;
        }
        .address{
            background:#f8f9fa;padding:12px 16px;
            border-radius:10px;margin-top:8px;
            font-size:15px;border-left:4px solid #800000;
        }
        button{
            width:100%;padding:16px;
            background:#800000;color:#fff;
            border:none;border-radius:12px;
            font-size:18px;font-weight:700;
            cursor:pointer;margin-top:30px;
            transition:0.3s;
        }
        button:disabled{ background:#ccc;cursor:not-allowed; }
        button:not(:disabled):hover{ background:#a00000;transform:translateY(-2px); }
    </style>
</head>
<body>

<header class="header">
    <button class="back-btn" onclick="history.back()">←</button>
    <h1>Yangi reys yaratish</h1>
</header>

<div class="container">
    <div class="card">
        <div class="form">

            <label>Qayerdan (viloyat)</label>
            <select id="fromInput" required>
                <option value="">Tanlang...</option>
            </select>

            <label>Qayerga (viloyat)</label>
            <select id="toInput" required>
                <option value="">Tanlang...</option>
            </select>

            <div class="status" id="status">
                Xaritada avval <strong>yashil nuqta</strong> (ketish), keyin <strong>qizil nuqta</strong> (yetib borish) joyini bosing
            </div>

            <div id="map"></div>

            <div class="address" id="fromAddress">Hali tanlanmadi</div>
            <div class="address" id="toAddress">Hali tanlanmadi</div>

            <label>O‘rinlar soni</label>
            <input type="number" id="seats" min="1" max="50" value="4" required>

            <label>Narx (so‘m)</label>
            <input type="number" id="price" min="10000" step="1000" placeholder="250 000" required>

            <label>Ketish sanasi va vaqti</label>
            <input type="datetime-local" id="departure" required>

            <button id="submitBtn" disabled>Reys yaratish</button>
        </div>
    </div>
</div>

<input type="hidden" id="fromLat"><input type="hidden" id="fromLng">
<input type="hidden" id="toLat"><input type="hidden" id="toLng">

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const token = localStorage.getItem('token');
if (!token) location.href = 'login.html';

const regions = ["TOSHKENT","NAVOIY","SAMARKAND","BUXORO","QASHQADARYO","XORAZM","SURXONDARYO","JIZZAX","SIRDARYO","QORAQALPOGISTON","ANDIJON","NAMANGAN","FARGONA"];

const fromInput = document.getElementById('fromInput');
const toInput   = document.getElementById('toInput');
const fromAddr  = document.getElementById('fromAddress');
const toAddr    = document.getElementById('toAddress');
const status    = document.getElementById('status');
const submitBtn = document.getElementById('submitBtn');

regions.forEach(r => {
    const text = r.charAt(0) + r.slice(1).toLowerCase();
    fromInput.add(new Option(text, r));
    toInput.add(new Option(text, r));
});

let map, fromMarker, toMarker;
let clickCount = 0; // 0 = hech nima, 1 = from tanlandi, 2 = to tanlandi

function initMap() {
    map = L.map('map').setView([41.311081, 69.240562], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap'
    }).addTo(map);

    map.on('click', e => {
        if (clickCount === 0) {
            placeMarker(e.latlng, 'from');
        } else if (clickCount === 1) {
            placeMarker(e.latlng, 'to');
        }
    });
}

function placeMarker(latlng, type) {
    const isFrom = type === 'from';
    const markerRef = isFrom ? fromMarker : toMarker;
    if (markerRef) markerRef.remove();

    const color = isFrom ? '#2e7d32' : '#c62828';
    const letter = isFrom ? 'F' : 'T';

    const icon = L.divIcon({
        html: `<div style="background:${color};color:white;width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:20px;border:4px solid white;box-shadow:0 4px 15px rgba(0,0,0,0.3);">${letter}</div>`,
        iconSize: [40,40],
        iconAnchor: [20,40]
    });

    const marker = L.marker(latlng, {icon}).addTo(map);
    if (isFrom) fromMarker = marker; else toMarker = marker;

    reverseGeocode(latlng, type);
}

async function reverseGeocode(latlng, type) {
    try {
        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latlng.lat}&lon=${latlng.lng}&zoom=18`);
        const data = await res.json();
        const addr = data.display_name || "Manzil topilmadi";

        if (type === 'from') {
            document.getElementById('fromLat').value = latlng.lat.toFixed(6);
            document.getElementById('fromLng').value = latlng.lng.toFixed(6);
            fromAddr.textContent = addr;
            status.innerHTML = 'Endi <strong>qizil nuqta</strong> (yetib borish) joyini bosing';
            clickCount = 1;
        } else {
            document.getElementById('toLat').value = latlng.lat.toFixed(6);
            document.getElementById('toLng').value = latlng.lng.toFixed(6);
            toAddr.textContent = addr;
            status.innerHTML = 'Ikkala nuqta tanlandi! Maydonlarni to‘ldiring';
            status.style.background = '#e8f5e9';
            status.style.color = '#2e7d32';
            clickCount = 2;
        }
        checkReady();
    } catch (err) {
        alert("Internet aloqasi yo‘q");
    }
}

// Barcha inputlarni kuzatish
const inputs = [fromInput, toInput, document.getElementById('seats'), document.getElementById('price'), document.getElementById('departure')];
inputs.forEach(el => el.addEventListener('input', checkReady));
inputs.forEach(el => el.addEventListener('change', checkReady));

function checkReady() {
    const ready = fromInput.value && toInput.value &&
                  document.getElementById('fromLat').value &&
                  document.getElementById('toLat').value &&
                  document.getElementById('seats').value >= 1 &&
                  document.getElementById('price').value >= 10000 &&
                  document.getElementById('departure').value;

    submitBtn.disabled = !ready;
}

// Yuborish
submitBtn.onclick = async () => {
    if (submitBtn.disabled) return;
    submitBtn.disabled = true;
    submitBtn.textContent = "Yuborilmoqda...";

    const payload = {
        from: fromInput.value,
        to: toInput.value,
        fromLat: parseFloat(document.getElementById('fromLat').value),
        fromLng: parseFloat(document.getElementById('fromLng').value),
        fromAddress: fromAddr.textContent,
        toLat: parseFloat(document.getElementById('toLat').value),
        toLng: parseFloat(document.getElementById('toLng').value),
        toAddress: toAddr.textContent,
        seatsCount: +document.getElementById('seats').value,
        price: +document.getElementById('price').value,
        departureDate: new Date(document.getElementById('departure').value).toISOString()
    };

    try {
        const res = await fetch("https://api.rout24.online/routes", {
            method: "POST",
            headers: { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });
        const json = await res.json();
        if (json.success) {
            alert("Reys muvaffaqiyatli yaratildi!");
            location.href = "my-routes.html";
        } else throw new Error(json.message || "Xato");
    } catch (err) {
        alert("Xatolik: " + err.message);
        submitBtn.disabled = false;
        submitBtn.textContent = "Reys yaratish";
    }
};

// Boshlash
initMap();
</script>
</body>
</html>