<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yangi reys yaratish</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 560px;
            margin: 0 auto;
            background: white;
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            animation: fadeIn 0.6s ease-out;
        }
        @keyframes fadeIn { from {opacity:0; transform:translateY(30px)} to {opacity:1; transform:none} }

        .header {
            background: linear-gradient(135deg, #800000, #b71c1c);
            color: white;
            padding: 32px 24px;
            text-align: center;
        }
        .header h1 { font-size: 26px; font-weight: 800; }
        .header p { opacity: 0.9; margin-top: 8px; font-size: 15px; }

        .form {
            padding: 32px 28px;
        }
        .step {
            margin-bottom: 28px;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.4s ease;
        }
        .step.active {
            opacity: 1;
            transform: none;
        }
        label {
            display: block;
            font-weight: 700;
            margin-bottom: 10px;
            color: #800000;
            font-size: 16px;
        }
        select, input, button {
            width: 100%;
            padding: 14px 16px;
            border-radius: 12px;
            border: 2px solid #eee;
            font-size: 16px;
            transition: all 0.3s;
        }
        select:focus, input:focus {
            outline: none;
            border-color: #800000;
            box-shadow: 0 0 0 4px rgba(128,0,0,0.1);
        }
        #map {
            height: 360px;
            border-radius: 16px;
            margin: 20px 0;
            border: 3px solid #ddd;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .marker-hint {
            text-align: center;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 12px;
            font-weight: 600;
            margin: 16px 0;
            color: #555;
        }
        .marker-hint.from { border-left: 5px solid #4caf50; }
        .marker-hint.to { border-left: 5px solid #f44336; }

        button#submitBtn {
            margin-top: 32px;
            background: #800000;
            color: white;
            font-weight: 700;
            font-size: 18px;
            cursor: pointer;
            padding: 16px;
        }
        button#submitBtn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        button#submitBtn:not(:disabled):hover {
            background: #a00000;
            transform: translateY(-2px);
        }

        .address-display {
            background: #f8f9fa;
            padding: 12px 16px;
            border-radius: 10px;
            margin-top: 10px;
            font-size: 15px;
            color: #333;
            border-left: 4px solid #800000;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Yangi reys yaratish</h1>
        <p>Birinchi “Qayerdan”, keyin “Qayerga” belgilang</p>
    </div>

    <div class="form">
        <!-- 1-qadam: Qayerdan -->
        <div class="step" id="stepFromRegion">
            <label>Qayerdan (viloyat)</label>
            <select id="fromInput"></select>
        </div>

        <!-- Xarita + Qayerdan nuqtasi -->
        <div class="step hidden" id="stepFromMap">
            <div class="marker-hint from">
                Xaritada <strong>yashil nuqta</strong> joyini bosing — bu <strong>Qayerdan</strong>
            </div>
            <div id="map"></div>
            <div class="address-display" id="fromAddressDisplay">Belgilanyapti...</div>
        </div>

        <!-- 2-qadam: Qayerga -->
        <div class="step hidden" id="stepToRegion">
            <label>Qayerga (viloyat)</label>
            <select id="toInput"></select>
        </div>

        <!-- Qayerga nuqtasi -->
        <div class="step hidden" id="stepToMap">
            <div class="marker-hint to">
                Xaritada <strong>qizil nuqta</strong> joyini bosing — bu <strong>Qayerga</strong>
            </div>
            <div id="map2" class="hidden"></div>
            <div class="address-display" id="toAddressDisplay">Belgilanyapti...</div>
        </div>

        <!-- Qolgan maydonlar -->
        <div class="step hidden" id="finalFields">
            <label>O‘rinlar soni</label>
            <input type="number" id="seats" min="1" max="50" value="4">

            <label>Narx (so‘m)</label>
            <input type="number" id="price" min="10000" step="1000" placeholder="masalan: 250000">

            <label>Ketish sanasi va vaqti</label>
            <input type="datetime-local" id="departure">
        </div>

        <button id="submitBtn" disabled>Yuborilmoqda...</button>
    </div>
</div>

<!-- Hidden inputs -->
<input type="hidden" id="fromLat"><input type="hidden" id="fromLng">
<input type="hidden" id="toLat"><input type="hidden" id="toLng">

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const token = localStorage.getItem('token');
if (!token) location.href = 'login.html';

const regions = ["TOSHKENT","NAVOIY","SAMARKAND","BUXORO","QASHQADARYO","XORAZM","SURXONDARYO","JIZZAX","SIRDARYO","QORAQALPOGISTON","ANDIJON","NAMANGAN","FARGONA"];
const fromInput = document.getElementById('fromInput');
const toInput = document.getElementById('toInput');
const submitBtn = document.getElementById('submitBtn');

regions.forEach(r => {
    const text = r.charAt(0) + r.slice(1).toLowerCase();
    fromInput.add(new Option(text, r));
    toInput.add(new Option(text, r));
});

// Elementlar
const steps = {
    fromRegion: document.getElementById('stepFromRegion'),
    fromMap: document.getElementById('stepFromMap'),
    toRegion: document.getElementById('stepToRegion'),
    toMap: document.getElementById('stepToMap'),
    final: document.getElementById('finalFields')
};

let map, fromMarker, toMarker;
let currentStep = 'fromRegion';
let selectedType = null;

// Xarita yaratish
function initMap() {
    map = L.map("map").setView([41.311081, 69.240562], 10);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
    map.on('click', onMapClick);
}

// Xarita bosilganda
function onMapClick(e) {
    if (!selectedType) return;

    const latlng = e.latlng;
    placeMarker(latlng);
    reverseGeocode(latlng);
}

function placeMarker(latlng) {
    if (selectedType === 'from' && fromMarker) fromMarker.remove();
    if (selectedType === 'to' && toMarker) toMarker.remove();

    const icon = L.divIcon({
        html: selectedType === 'from'
            ? '<div style="background:#4caf50;color:white;width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:18px;border:4px solid white;box-shadow:0 4px 15px rgba(0,0,0,0.3);">F</div>'
            : '<div style="background:#f44336;color:white;width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:18px;border:4px solid white;box-shadow:0 4px 15px rgba(0,0,0,0.3);">T</div>',
        iconSize: [38, 38],
        iconAnchor: [19, 38]
    });

    const marker = L.marker(latlng, { icon }).addTo(map);
    if (selectedType === 'from') fromMarker = marker;
    else toMarker = marker;
}

async function reverseGeocode(latlng) {
    try {
        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latlng.lat}&lon=${latlng.lng}&zoom=18&addressdetails=1`);
        const data = await res.json();
        const addr = data.display_name || "Manzil topilmadi";

        if (selectedType === 'from') {
            document.getElementById('fromLat').value = latlng.lat.toFixed(6);
            document.getElementById('fromLng').value = latlng.lng.toFixed(6);
            document.getElementById('fromAddressDisplay').textContent = addr;
            nextStep('toRegion');
        } else {
            document.getElementById('toLat').value = latlng.lat.toFixed(6);
            document.getElementById('toLng').value = latlng.lng.toFixed(6);
            document.getElementById('toAddressDisplay').textContent = addr;
            nextStep('final');
        }
    } catch {
        alert("Internet aloqasi yo‘q yoki manzil aniqlanmadi");
    }
}

function nextStep(stepName) {
    Object.values(steps).forEach(s => s.classList.remove('active'));
    steps[stepName].classList.add('active');
    currentStep = stepName;

    if (stepName === 'final') {
        document.getElementById('submitBtn').disabled = false;
        document.getElementById('submitBtn').textContent = "Reys yaratish";
    }
}

// Qayerdan tanlandi
fromInput.onchange = () => {
    if (!fromInput.value) return;
    selectedType = 'from';
    nextStep('fromMap');
};

// Qayerga tanlandi
toInput.onchange = () => {
    if (!toInput.value) return;
    selectedType = 'to';
    nextStep('toMap');
};

// Yakuniy maydonlar o‘zgarishi
document.getElementById('seats').oninput =
document.getElementById('price').oninput =
document.getElementById('departure').oninput = () => {
    const ready = document.getElementById('seats').value >= 1 &&
                  document.getElementById('price').value >= 10000 &&
                  document.getElementById('departure').value;
    submitBtn.disabled = !ready;
};

// Yuborish
submitBtn.onclick = async () => {
    if (submitBtn.disabled) return;
    submitBtn.disabled = true;
    submitBtn.textContent = "Yuborilmoqda...";

    const payload = {
        from: fromInput.value,
        to: toInput.value,
        fromLat: parseFloat(document.getElementById('fromLat').value),
        fromLng: parseFloat(document.getElementById('fromLng').value),
        fromAddress: document.getElementById('fromAddressDisplay').textContent,
        toLat: parseFloat(document.getElementById('toLat').value),
        toLng: parseFloat(document.getElementById('toLng').value),
        toAddress: document.getElementById('toAddressDisplay').textContent,
        seatsCount: parseInt(document.getElementById('seats').value),
        price: parseInt(document.getElementById('price').value),
        departureDate: new Date(document.getElementById('departure').value).toISOString()
    };

    try {
        const res = await fetch("https://api.rout24.online/routes/create", {
            method: "POST",
            headers: { Authorization: `Bearer ${token}`, "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });
        const json = await res.json();
        if (json.success) {
            alert("Reys muvaffaqiyatli yaratildi!");
            location.href = "my-routes.html";
        } else throw new Error(json.message || "Xato");
    } catch (err) {
        alert("Xatolik: " + err.message);
        submitBtn.disabled = false;
        submitBtn.textContent = "Reys yaratish";
    }
};

// Boshlash
initMap();
steps.fromRegion.classList.add('active');
</script>
</body>
</html>